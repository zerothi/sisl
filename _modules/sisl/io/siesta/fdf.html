

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sisl.io.siesta.fdf &mdash; sisl</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css?v=4c969af8" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom_styles.css?v=cafe85c1" />
      <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=9d09c2c4"></script>
      <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../_static/copybutton.js?v=7800a641"></script>
      <script src="../../../../_static/tabs.js?v=3ee01567"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../../../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            sisl
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cite.html">Citing sisl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../visualization/index.html">Visualization (<code class="xref py py-obj docutils literal notranslate"><span class="pre">sisl.viz</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scripts/index.html">Command line scripts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../environment.html">Environment variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../toolbox/index.html">Toolboxes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev/index.html">Contributing to sisl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extras</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../math.html">Mathematical notation convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../release.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../other.html">Related software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../references.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">sisl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sisl.io.siesta.fdf</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sisl.io.siesta.fdf</h1><div class="highlight"><pre>
<span></span><span class="c1"># This Source Code Form is subject to the terms of the Mozilla Public</span>
<span class="c1"># License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<span class="c1"># file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">itools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">isfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sisl._array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_a</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Atom</span><span class="p">,</span>
    <span class="n">AtomGhost</span><span class="p">,</span>
    <span class="n">Atoms</span><span class="p">,</span>
    <span class="n">DynamicalMatrix</span><span class="p">,</span>
    <span class="n">Geometry</span><span class="p">,</span>
    <span class="n">Grid</span><span class="p">,</span>
    <span class="n">Lattice</span><span class="p">,</span>
    <span class="n">Orbital</span><span class="p">,</span>
    <span class="n">SphericalOrbital</span><span class="p">,</span>
    <span class="n">constant</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl._help</span><span class="w"> </span><span class="kn">import</span> <span class="n">has_module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl._indices</span><span class="w"> </span><span class="kn">import</span> <span class="n">indices_only</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl._internal</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">SislError</span><span class="p">,</span> <span class="n">deprecate_argument</span><span class="p">,</span> <span class="n">deprecation</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">warn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl.physics</span><span class="w"> </span><span class="kn">import</span> <span class="n">BandStructure</span><span class="p">,</span> <span class="n">BrillouinZone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl.unit.siesta</span><span class="w"> </span><span class="kn">import</span> <span class="n">unit_convert</span><span class="p">,</span> <span class="n">unit_default</span><span class="p">,</span> <span class="n">unit_group</span><span class="p">,</span> <span class="n">units</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl.utils.cmd</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_ArgumentParser</span><span class="p">,</span> <span class="n">default_namespace</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl.utils.mathematics</span><span class="w"> </span><span class="kn">import</span> <span class="n">fnorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl.utils.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">merge_instances</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sisl.utils.ranges</span><span class="w"> </span><span class="kn">import</span> <span class="n">list2str</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.._help</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..sile</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MissingFermiLevelWarning</span><span class="p">,</span>
    <span class="n">SileCDF</span><span class="p">,</span>
    <span class="n">SileError</span><span class="p">,</span>
    <span class="n">add_sile</span><span class="p">,</span>
    <span class="n">get_sile_class</span><span class="p">,</span>
    <span class="n">sile_fh_open</span><span class="p">,</span>
    <span class="n">sile_raise_write</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.bands</span><span class="w"> </span><span class="kn">import</span> <span class="n">bandsSileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.basis</span><span class="w"> </span><span class="kn">import</span> <span class="n">ionncSileSiesta</span><span class="p">,</span> <span class="n">ionxmlSileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.binaries</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">dmSileSiesta</span><span class="p">,</span>
    <span class="n">hsxSileSiesta</span><span class="p">,</span>
    <span class="n">onlysSileSiesta</span><span class="p">,</span>
    <span class="n">tsdeSileSiesta</span><span class="p">,</span>
    <span class="n">tshsSileSiesta</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.eig</span><span class="w"> </span><span class="kn">import</span> <span class="n">eigSileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.fa</span><span class="w"> </span><span class="kn">import</span> <span class="n">faSileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.fc</span><span class="w"> </span><span class="kn">import</span> <span class="n">fcSileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.orb_indx</span><span class="w"> </span><span class="kn">import</span> <span class="n">orbindxSileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.siesta_grid</span><span class="w"> </span><span class="kn">import</span> <span class="n">gridncSileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.siesta_nc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ncSileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.sile</span><span class="w"> </span><span class="kn">import</span> <span class="n">MissingFDFSiestaInfo</span><span class="p">,</span> <span class="n">SileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.struct</span><span class="w"> </span><span class="kn">import</span> <span class="n">structSileSiesta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.xv</span><span class="w"> </span><span class="kn">import</span> <span class="n">xvSileSiesta</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fdfSileSiesta&quot;</span><span class="p">]</span>


<span class="n">_LOGICAL_TRUE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.true.&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">]</span>
<span class="n">_LOGICAL_FALSE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.false.&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">]</span>
<span class="n">_LOGICAL</span> <span class="o">=</span> <span class="n">_LOGICAL_FALSE</span> <span class="o">+</span> <span class="n">_LOGICAL_TRUE</span>

<span class="n">Bohr2Ang</span> <span class="o">=</span> <span class="n">unit_convert</span><span class="p">(</span><span class="s2">&quot;Bohr&quot;</span><span class="p">,</span> <span class="s2">&quot;Ang&quot;</span><span class="p">)</span>
<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_order_remove_netcdf</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes the order elements that refer to siles based on NetCDF&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_module</span><span class="p">(</span><span class="s2">&quot;netCDF4&quot;</span><span class="p">):</span>
        <span class="c1"># We got an import error</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">accept</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sile</span> <span class="o">=</span> <span class="n">get_sile_class</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="se">{{</span><span class="s2">contains=siesta</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="c1"># we just let it slip</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">sile</span><span class="p">,</span> <span class="n">SileCDF</span><span class="p">)</span>

        <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">accept</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">order</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_order</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_order_remove_netcdf</span><span class="p">(</span><span class="n">parse_order</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_track</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="n">msg_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="n">track</span><span class="p">:</span>
        <span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_track_file</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: file &#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&#39; exists.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: file &#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">MissingFDFSiestaInfo</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">_track</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>


<span class="nd">@set_module</span><span class="p">(</span><span class="s2">&quot;sisl.io.siesta&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">fdfSileSiesta</span><span class="p">(</span><span class="n">SileSiesta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FDF-input file</span>

<span class="sd">    By supplying base you can reference files in other directories.</span>
<span class="sd">    By default the ``base`` is the directory given in the file name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename: str</span>
<span class="sd">       fdf file</span>
<span class="sd">    mode : str, optional</span>
<span class="sd">       opening mode, default to read-only</span>
<span class="sd">    base : str, optional</span>
<span class="sd">       base-directory to read output files from.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; fdf = fdfSileSiesta(&quot;tmp/RUN.fdf&quot;) # reads output files in &quot;tmp/&quot; folder</span>
<span class="sd">    &gt;&gt;&gt; fdf = fdfSileSiesta(&quot;tmp/RUN.fdf&quot;, base=&quot;.&quot;) # reads output files in &quot;./&quot; folder</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup the `fdfSileSiesta` after initialization&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">]</span>

        <span class="c1"># List of parent file-handles used while reading</span>
        <span class="c1"># This is because fdf enables inclusion of other files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_fh</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Public key for printing information about where stuff comes from</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_pushfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We currently don&#39;t allow spaces/newlines/tabs at either end of the file name</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">f1</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_fh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">f2</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">.gz&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_fh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rt&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2"> is trying to include file: </span><span class="si">{</span><span class="n">f1</span><span class="si">!s}</span><span class="s2"> but the file seems not to exist? Will disregard file!&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_popfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_fh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_fh</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_seek</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Closes all files, and starts over from beginning&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_popfile</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="fdfSileSiesta.includes">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.includes">[docs]</a>
    <span class="nd">@sile_fh_open</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">includes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of all files that are *included* or otherwise necessary for reading the fdf file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">()</span>

        <span class="c1"># In FDF files, %include marks files that progress</span>
        <span class="c1"># down in a tree structure</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">includes</span><span class="p">:</span>
                <span class="n">includes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># List of includes</span>
        <span class="n">includes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">l</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ls</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;</span><span class="si">%i</span><span class="s2">nclude&quot;</span> <span class="o">==</span> <span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">add</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pushfile</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="s2">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span>
                    <span class="c1"># TODO, in principle the &lt; could contain</span>
                    <span class="c1"># include if this line is not a %block.</span>
                    <span class="n">add</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="n">ls</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">l</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="c1"># last line of file</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_popfile</span><span class="p">():</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">includes</span></div>


    <span class="nd">@sile_fh_open</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_r_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try and read the first occurence of a key</span>

<span class="sd">        This will take care of blocks, labels and piped in labels</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        label : str</span>
<span class="sd">           label to find in the fdf file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">tolabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">label</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">labell</span> <span class="o">=</span> <span class="n">tolabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">valid_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">labell</span>

            <span class="c1"># Split line by spaces</span>
            <span class="c1"># Generally we only need to split once, and hence</span>
            <span class="c1"># we use maxsplit, this should be a bit faster...</span>
            <span class="c1"># At least when reading *MANY* files this can greatly</span>
            <span class="c1"># impact performance.</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nls</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Make a lower equivalent of ls</span>
            <span class="n">ls0</span> <span class="o">=</span> <span class="n">tolabel</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Check if there is a pipe in the line</span>
            <span class="k">if</span> <span class="n">nls</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># Split the rest, we do it here since it has a severe perf. impact</span>
                <span class="c1"># by splitting the line, and joining again, so better to have it separated</span>
                <span class="c1"># in the few corner cases we see in input files.</span>
                <span class="n">ls_left</span><span class="p">,</span> <span class="n">ls_right</span> <span class="o">=</span> <span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
                <span class="c1"># The file should be stripped of lines</span>
                <span class="n">ls_right</span> <span class="o">=</span> <span class="n">ls_right</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c1"># get all labels on the LHS of &#39;&lt;&#39;</span>
                <span class="n">lsN</span> <span class="o">=</span> <span class="p">[</span><span class="n">tolabel</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ls_left</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="c1"># Now there are two cases</span>

                <span class="c1"># 1. It is a block, in which case</span>
                <span class="c1">#    the full block is piped into the label</span>
                <span class="c1">#    %block Label &lt; file</span>
                <span class="k">if</span> <span class="n">ls0</span> <span class="o">==</span> <span class="s2">&quot;%block&quot;</span> <span class="ow">and</span> <span class="n">lsN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">labell</span><span class="p">:</span>
                    <span class="c1"># Correct line found</span>
                    <span class="c1"># Read the file content, removing any empty and/or comment lines</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="n">ls_right</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">valid_line</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>

                <span class="c1"># 2. There are labels that should be read from a subsequent file</span>
                <span class="c1">#    Label1 Label2 &lt; other.fdf</span>
                <span class="k">if</span> <span class="n">ls0</span> <span class="o">==</span> <span class="n">labell</span> <span class="ow">or</span> <span class="n">labell</span> <span class="ow">in</span> <span class="n">lsN</span><span class="p">:</span>
                    <span class="c1"># Valid line, read key from other.fdf</span>
                    <span class="k">return</span> <span class="n">fdfSileSiesta</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="n">ls_right</span><span class="p">),</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_directory</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">_r_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

                <span class="c1"># It is not in this line, either key is</span>
                <span class="c1"># on the RHS of &lt;, or the key could be &quot;block&quot;. Say.</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># The last case is if the label is the first word on the line</span>
            <span class="c1"># In that case we have found what we are looking for</span>
            <span class="k">if</span> <span class="n">ls0</span> <span class="o">==</span> <span class="n">labell</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nls</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                <span class="k">return</span> <span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">ls0</span> <span class="o">==</span> <span class="s2">&quot;%block&quot;</span><span class="p">:</span>
                <span class="c1"># we had only split once</span>
                <span class="k">if</span> <span class="n">tolabel</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">labell</span><span class="p">:</span>
                    <span class="c1"># Read in the block content</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># Now read lines</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">ndblock&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">lines</span>

            <span class="k">elif</span> <span class="n">ls0</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">%i</span><span class="s2">nclude&quot;</span><span class="p">:</span>
                <span class="c1"># We have to open a new file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pushfile</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Perform actual reading of line</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">process_line</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">while</span> <span class="n">l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_popfile</span><span class="p">():</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">process_line</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">l</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the type by the value</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : str or list or numpy.ndarray</span>
<span class="sd">            the value to check for fdf-type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># A block, %block ...</span>
            <span class="k">return</span> <span class="s2">&quot;B&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># A list, Label [...]</span>
            <span class="k">return</span> <span class="s2">&quot;a&quot;</span>

        <span class="c1"># Grab the entire line (beside the key)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fdf</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fdf</span> <span class="ow">in</span> <span class="n">_LOGICAL</span><span class="p">:</span>
                <span class="c1"># logical</span>
                <span class="k">return</span> <span class="s2">&quot;b&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">fdf</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">fdf</span><span class="p">:</span>
                    <span class="c1"># a real number (otherwise an integer)</span>
                    <span class="k">return</span> <span class="s2">&quot;r&quot;</span>
                <span class="k">return</span> <span class="s2">&quot;i&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># fall-back to name with everything</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># possibly a physical value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="s2">&quot;p&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="s2">&quot;n&quot;</span>

<div class="viewcode-block" id="fdfSileSiesta.type">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.type">[docs]</a>
    <span class="nd">@sile_fh_open</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the type of the fdf-keyword</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        label : str</span>
<span class="sd">            the label to look-up</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_label</span><span class="p">(</span><span class="n">label</span><span class="p">))</span></div>


<div class="viewcode-block" id="fdfSileSiesta.get">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.get">[docs]</a>
    <span class="nd">@sile_fh_open</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">with_unit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve fdf-keyword from the file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        label : str</span>
<span class="sd">            the fdf-label to search for</span>
<span class="sd">        default : optional</span>
<span class="sd">            if the label is not found, this will be the returned value (default to ``None``)</span>
<span class="sd">        unit : str, optional</span>
<span class="sd">            unit of the physical quantity to return</span>
<span class="sd">        with_unit : bool, optional</span>
<span class="sd">            whether the physical quantity gets returned with the found unit in the fdf file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        value : the value of the fdf-label. If the label is a block, a `list` is returned, for</span>
<span class="sd">                a real value a `float` (or if the default is of `float`), for an integer, an</span>
<span class="sd">                `int` is returned.</span>
<span class="sd">        unit : if `with_unit` is true this will contain the associated unit if it is specified</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; print(open(...).readlines())</span>
<span class="sd">        LabeleV 1. eV</span>
<span class="sd">        LabelRy 1. Ry</span>
<span class="sd">        Label name</span>
<span class="sd">        FakeInt 1</span>
<span class="sd">        %block Hello</span>
<span class="sd">        line 1</span>
<span class="sd">        line2</span>
<span class="sd">        %endblock</span>
<span class="sd">        &gt;&gt;&gt; fdf.get(&quot;LabeleV&quot;) == 1. # default unit is eV</span>
<span class="sd">        &gt;&gt;&gt; fdf.get(&quot;LabelRy&quot;) == unit.siesta.unit_convert(&quot;Ry&quot;, &quot;eV&quot;)</span>
<span class="sd">        &gt;&gt;&gt; fdf.get(&quot;LabelRy&quot;, unit=&quot;Ry&quot;) == 1.</span>
<span class="sd">        &gt;&gt;&gt; fdf.get(&quot;LabelRy&quot;, with_unit=True) == (1., &quot;Ry&quot;)</span>
<span class="sd">        &gt;&gt;&gt; fdf.get(&quot;FakeInt&quot;, &quot;0&quot;) == &quot;1&quot;</span>
<span class="sd">        &gt;&gt;&gt; fdf.get(&quot;LabeleV&quot;, with_unit=True) == (1., &quot;eV&quot;)</span>
<span class="sd">        &gt;&gt;&gt; fdf.get(&quot;Label&quot;, with_unit=True) == &quot;name&quot; # no unit present on line</span>
<span class="sd">        &gt;&gt;&gt; fdf.get(&quot;Hello&quot;) == [&quot;line 1&quot;, &quot;line2&quot;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try and read a line</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># Simply return the default value if not found</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

        <span class="c1"># Figure out what it is</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># We will only do something if it is a real, int, or physical.</span>
        <span class="c1"># Else we simply return, as-is</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">with_unit</span><span class="p">:</span>
                <span class="c1"># Simply return, as is. Let the user do whatever.</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">unit_default</span><span class="p">(</span><span class="n">unit_group</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">unit_group</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="n">unit_group</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Requested unit for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> is not the same type. &quot;</span>
                        <span class="s2">&quot;Found/Requested </span><span class="si">{value[1]}</span><span class="s2">/</span><span class="si">{unit}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">unit</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">unit_convert</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">_LOGICAL_TRUE</span>

        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="fdfSileSiesta.set">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">keep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the key and value to the FDF file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">           the fdf-key value to be set in the fdf file</span>
<span class="sd">        value : str or list of str</span>
<span class="sd">           the value of the string. If a `str` is passed a regular</span>
<span class="sd">           fdf-key is used, if a `list` it will be a %block.</span>
<span class="sd">        keep : bool, optional</span>
<span class="sd">           whether old flags will be kept in the fdf file. In this case</span>
<span class="sd">           a time-stamp will be written to show when the key was overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># To set a key we first need to figure out if it is</span>
        <span class="c1"># already present, if so, we will add the new key, just above</span>
        <span class="c1"># the already present key.</span>
        <span class="n">top_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># 1. find the old value, and thus the file in which it is found</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">top_file</span><span class="p">):</span>
            <span class="n">same_fdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">top_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">same_fdf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="c1"># Get the file of the containing data</span>
                <span class="n">top_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">same_fdf</span><span class="o">.</span><span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Ensure that all files are closed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span>

        <span class="c1"># Now we should re-read and edit the file</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">top_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Now loop, write and edit</span>
        <span class="n">do_write</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">lkey</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">top_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_has_key</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">lkey</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">do_write</span><span class="p">:</span>
                    <span class="n">write</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;# Old value (</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">do_write</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">do_write</span><span class="p">:</span>
                <span class="n">write</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># ensure the file is-reopened</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span></div>


<div class="viewcode-block" id="fdfSileSiesta.print">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.print">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string which is pretty-printing the key+value&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;%block </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># if the value has any new-values</span>
            <span class="n">has_nl</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">has_nl</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">has_nl</span><span class="p">:</span>
                <span class="c1"># copy list, we are going to change it</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:]</span>
                <span class="c1"># do not skip to next line in next segment</span>
                <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{s}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{v}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="c1"># We add an extra line after blocks</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">%endblock </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="fdfSileSiesta.write_lattice">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.write_lattice">[docs]</a>
    <span class="nd">@sile_fh_open</span><span class="p">()</span>
    <span class="nd">@deprecate_argument</span><span class="p">(</span><span class="s2">&quot;sc&quot;</span><span class="p">,</span> <span class="s2">&quot;lattice&quot;</span><span class="p">,</span> <span class="s2">&quot;use lattice= instead of sc=&quot;</span><span class="p">,</span> <span class="s2">&quot;0.15&quot;</span><span class="p">,</span> <span class="s2">&quot;0.17&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lattice</span><span class="p">:</span> <span class="n">Lattice</span><span class="p">,</span> <span class="n">fmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.8f&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes the supercell</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lattice:</span>
<span class="sd">           supercell object to write</span>
<span class="sd">        fmt :</span>
<span class="sd">           precision used to store the lattice vectors</span>
<span class="sd">        unit : {&quot;Ang&quot;, &quot;Bohr&quot;}</span>
<span class="sd">           the unit used when writing the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sile_raise_write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">fmt_str</span> <span class="o">=</span> <span class="s2">&quot; {{0:</span><span class="si">{0}</span><span class="s2">}} {{1:</span><span class="si">{0}</span><span class="s2">}} {{2:</span><span class="si">{0}</span><span class="s2">}}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>

        <span class="n">unit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="s2">&quot;Ang&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Ang&quot;</span><span class="p">,</span> <span class="s2">&quot;Bohr&quot;</span><span class="p">):</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">unit_convert</span><span class="p">(</span><span class="s2">&quot;Ang&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;Ang&quot;</span>

        <span class="c1"># Write out the cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LatticeConstant 1.0 </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;%block LatticeVectors</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">fmt_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">lattice</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">conv</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">fmt_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">lattice</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">conv</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">fmt_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">lattice</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">conv</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">ndblock LatticeVectors</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="fdfSileSiesta.write_geometry">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.write_geometry">[docs]</a>
    <span class="nd">@sile_fh_open</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">fmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.8f&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes the geometry</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry :</span>
<span class="sd">           geometry object to write</span>
<span class="sd">        fmt :</span>
<span class="sd">           precision used to store the atomic coordinates</span>
<span class="sd">        unit : {&quot;Ang&quot;, &quot;Bohr&quot;, &quot;fractional&quot;, &quot;frac&quot;}</span>
<span class="sd">           the unit used when writing the data.</span>
<span class="sd">           fractional and frac are the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sile_raise_write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_lattice</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">lattice</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NumberOfAtoms </span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">na</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="s2">&quot;Ang&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="n">is_fractional</span> <span class="o">=</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Frac&quot;</span><span class="p">,</span> <span class="s2">&quot;Fractional&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_fractional</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;AtomicCoordinatesFormat Fractional</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">unit_convert</span><span class="p">(</span><span class="s2">&quot;Ang&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AtomicCoordinatesFormat </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;%block AtomicCoordinatesAndAtomicSpecies</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">n_species</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">atom</span><span class="p">)</span>

        <span class="c1"># Count for the species</span>
        <span class="k">if</span> <span class="n">is_fractional</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">fxyz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">xyz</span> <span class="o">*</span> <span class="n">conv</span>
            <span class="k">if</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                <span class="c1"># Correct for a &quot;same&quot; length of all coordinates</span>
                <span class="n">c_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">:</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">max</span><span class="p">())))</span>
                <span class="n">c_min</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">:</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">min</span><span class="p">())))</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">c_min</span><span class="p">,</span> <span class="n">c_max</span><span class="p">))</span> <span class="o">+</span> <span class="n">fmt</span>
        <span class="n">fmt_str</span> <span class="o">=</span> <span class="s2">&quot; {{3:</span><span class="si">{0}</span><span class="s2">}} {{4:</span><span class="si">{0}</span><span class="s2">}} {{5:</span><span class="si">{0}</span><span class="s2">}} {{0}} # {{1:</span><span class="si">{1}</span><span class="s2">d}}: {{2}}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">fmt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geometry</span><span class="p">)))</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">isp</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">iter_species</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">fmt_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ia</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="o">*</span><span class="n">xyz</span><span class="p">[</span><span class="n">ia</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">ndblock AtomicCoordinatesAndAtomicSpecies</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Write out species</span>
        <span class="c1"># First swap key and value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NumberOfSpecies </span><span class="si">{</span><span class="n">n_species</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;%block ChemicalSpeciesLabel</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">atom</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">AtomGhost</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">Z</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">Z</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">ndblock ChemicalSpeciesLabel</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">_write_block</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">write_block</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="n">write_block</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">write_block</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Constraints</span><span class="se">\n</span><span class="s2">%block Geometry.Constraints</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">write_block</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; atom [</span><span class="si">{</span><span class="n">atoms</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">append</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">write_block</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">append</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot; 1. 0. 0.&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot; 0. 1. 0.&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot; 0. 0. 1.&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;CONSTRAIN&quot;</span> <span class="o">+</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;-x&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;-y&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;-z&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">list2str</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; -- &quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2">.write_geometry will not write the constraints for </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> (too long line).&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_write_block</span> <span class="o">=</span> <span class="n">write_block</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="n">_write_block</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_write_block</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">ndblock</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="fdfSileSiesta.write_brillouinzone">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.write_brillouinzone">[docs]</a>
    <span class="nd">@sile_fh_open</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_brillouinzone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bz</span><span class="p">:</span> <span class="n">BrillouinZone</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Writes Brillouinzone information to the fdf input file</span>

<span class="sd">        The `bz` object will be written as options in the input file.</span>
<span class="sd">        The class of `bz` decides which options gets written. For instance</span>
<span class="sd">        a `BandStructure` class will write the corresponding ``BandLines`` block.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bz :</span>
<span class="sd">            which setting to write to the file</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Currently, only the `BandStructure` class may be accepted as `bz`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sile_raise_write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bz</span><span class="p">,</span> <span class="n">BandStructure</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.write_brillouinzone only implements BandStructure object writing.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;BandLinesScale ReciprocalLatticeVectors</span><span class="se">\n</span><span class="s2">%block BandLines</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">divs</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bz</span><span class="o">.</span><span class="n">divisions</span><span class="p">,</span> <span class="n">bz</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">bz</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">divs</span>
        <span class="n">point</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">bz</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bz</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">ndblock BandLines</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="fdfSileSiesta.read_lattice_nsc">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_lattice_nsc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_lattice_nsc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read supercell size using any method available</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        SislWarning</span>
<span class="sd">            if none of the files can be read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;ORB_INDX&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_lattice_nsc_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;number of supercells could not be read from output files. Assuming molecule cell &quot;</span>
            <span class="s2">&quot;(no supercell connections)&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_a</span><span class="o">.</span><span class="n">onesi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_lattice_nsc_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_lattice_nsc_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_lattice_nsc</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_lattice_nsc_orb_indx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ORB_INDX&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_r_lattice_nsc_orb_indx</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;Write.OrbitalIndex&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">orbindxSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_lattice_nsc</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="fdfSileSiesta.read_lattice">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_lattice">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lattice</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns Lattice object by reading fdf or Siesta output related files.</span>

<span class="sd">        One can limit the tried files to only one file by passing</span>
<span class="sd">        only a single file ending.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output:</span>
<span class="sd">            whether to read supercell from output files (True), or</span>
<span class="sd">            form the fdf file (False).</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the supercell.</span>
<span class="sd">            By default this is ``[XV, nc, TSHS, STRUCT, HSX, fdf]`` if `output` is true</span>
<span class="sd">            If `order` is present `output` is disregarded.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; fdf = get_sile(&quot;RUN.fdf&quot;)</span>
<span class="sd">        &gt;&gt;&gt; fdf.read_lattice() # read from fdf</span>
<span class="sd">        &gt;&gt;&gt; fdf.read_lattice(True) # read from [XV, nc, fdf]</span>
<span class="sd">        &gt;&gt;&gt; fdf.read_lattice(order=[&quot;nc&quot;]) # read from [nc]</span>
<span class="sd">        &gt;&gt;&gt; fdf.read_lattice(True, order=[&quot;nc&quot;]) # read from [nc]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;XV&quot;</span><span class="p">,</span> <span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;TSHS&quot;</span><span class="p">,</span> <span class="s2">&quot;STRUCT&quot;</span><span class="p">,</span> <span class="s2">&quot;HSX&quot;</span><span class="p">,</span> <span class="s2">&quot;fdf&quot;</span><span class="p">],</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;fdf&quot;</span><span class="p">},</span>
            <span class="n">output</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_lattice_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_lattice_fdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns `Lattice` object from the FDF file&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LatticeConstant&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Ang&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SileError</span><span class="p">(</span>
                <span class="s2">&quot;Could not find LatticeConstant in file: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_directory</span><span class="si">!s}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_file</span><span class="si">!s}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Read in cell</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">emptyd</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

        <span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LatticeVectors&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">cell</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LatticeParameters&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">6</span><span class="p">]]</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">tocell</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># the fdf file contains neither the latticevectors or parameters</span>
            <span class="k">raise</span> <span class="n">SileError</span><span class="p">(</span>
                <span class="s2">&quot;Could not find LatticeVectors or LatticeParameters block in file&quot;</span>
            <span class="p">)</span>
        <span class="n">cell</span> <span class="o">*=</span> <span class="n">s</span>

        <span class="c1"># When reading from the fdf, the warning should be suppressed</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">nsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_lattice_nsc</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">nsc</span><span class="o">=</span><span class="n">nsc</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_lattice_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read supercell from &lt;&gt;.nc file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_lattice_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_lattice</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_lattice_xv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns `Lattice` object from the XV file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.XV&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_lattice_xv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">nsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_lattice_nsc</span><span class="p">()</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="n">xvSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_lattice</span><span class="p">()</span>
            <span class="n">lattice</span><span class="o">.</span><span class="n">set_nsc</span><span class="p">(</span><span class="n">nsc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lattice</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_lattice_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns `Lattice` object from the STRUCT files&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;STRUCT_NEXT_ITER&quot;</span><span class="p">,</span> <span class="s2">&quot;STRUCT_OUT&quot;</span><span class="p">,</span> <span class="s2">&quot;STRUCT_IN&quot;</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_lattice_struct</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">nsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_lattice_nsc</span><span class="p">()</span>
                <span class="n">lattice</span> <span class="o">=</span> <span class="n">structSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_lattice</span><span class="p">()</span>
                <span class="n">lattice</span><span class="o">.</span><span class="n">set_nsc</span><span class="p">(</span><span class="n">nsc</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">lattice</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_lattice_tshs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSHS&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_lattice_tshs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.HS.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">tshsSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_lattice</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_lattice_hsx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.HSX&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_lattice_hsx</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;HS.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">hsxSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_lattice</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_lattice_onlys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.onlyS&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_lattice_onlys</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.S.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">onlysSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_lattice</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="fdfSileSiesta.read_force">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_force">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read forces from the output of the calculation (forces are not defined in the input)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order : list of str, optional</span>
<span class="sd">           the order of the forces we are trying to read, default to ``[&quot;FA&quot;, &quot;nc&quot;]``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray : vector with forces for each of the atoms, along each Cartesian direction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;FA&quot;</span><span class="p">,</span> <span class="s2">&quot;nc&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_force_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">(read_force) found in file=</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_force_fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read forces from the FA file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.FA&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_force_fa</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">faSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_force</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_force_fac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read forces from the FAC file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.FAC&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_force_fac</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">faSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_force</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_force_tsfa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read forces from the TSFA file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSFA&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_force_tsfa</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">faSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_force</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_force_tsfac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read forces from the TSFAC file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSFAC&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_force_tsfac</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">faSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_force</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_force_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read forces from the nc file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_force_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_force</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="fdfSileSiesta.read_hessian">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_hessian">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_hessian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read Hessian/force constant from the output of the calculation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        M : numpy.ndarray</span>
<span class="sd">            vector ``[*, 3, 2, *, 3]``  with Hessian/force constant element for each of the atomic displacements</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;FC&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_hessian_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">(read_hessian) found in file=</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="n">read_force_constant</span> <span class="o">=</span> <span class="n">deprecation</span><span class="p">(</span>
        <span class="s2">&quot;read_force_constant is deprecated in favor of read_hessian&quot;</span><span class="p">,</span> <span class="s2">&quot;0.15&quot;</span><span class="p">,</span> <span class="s2">&quot;0.17&quot;</span>
    <span class="p">)(</span><span class="n">read_hessian</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_hessian_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_hessian_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;FC&quot;</span> <span class="ow">in</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_hessian</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">fc</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_hessian_fc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.FC&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_hessian_fc</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NumberOfAtoms&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fcSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_hessian</span><span class="p">(</span><span class="n">na</span><span class="o">=</span><span class="n">na</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="fdfSileSiesta.read_fermi_level">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_fermi_level">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_fermi_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read Fermi-level from output of the calculation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the fermi-level.</span>
<span class="sd">            By default this is ``[&quot;nc&quot;, &quot;TSDE&quot;, &quot;TSHS&quot;, &quot;EIG&quot;, &quot;bands&quot;]``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            the fermi-level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;TSDE&quot;</span><span class="p">,</span> <span class="s2">&quot;TSHS&quot;</span><span class="p">,</span> <span class="s2">&quot;EIG&quot;</span><span class="p">,</span> <span class="s2">&quot;bands&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_fermi_level_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">(read_fermi_level) found in file=</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">MissingFermiLevelWarning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2"> could not find any Ef values.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_fermi_level_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_fermi_level_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_fermi_level</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_fermi_level_tsde</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSDE&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_fermi_level_tsde</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.DE.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tsdeSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_fermi_level</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_fermi_level_tshs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSHS&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_fermi_level_tshs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.HS.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tshsSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_fermi_level</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_fermi_level_eig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.EIG&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_fermi_level_eig</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">eigSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_fermi_level</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_fermi_level_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.bands&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_fermi_level_bands</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bandsSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_fermi_level</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="fdfSileSiesta.read_dynamical_matrix">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_dynamical_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_dynamical_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read dynamical matrix from output of the calculation</span>

<span class="sd">        Generally the mass is stored in the basis information output,</span>
<span class="sd">        but for dynamical matrices it makes sense to let the user control this,</span>
<span class="sd">        e.g. through the fdf file.</span>
<span class="sd">        By default the mass will be read from the AtomicMass key in the fdf file</span>
<span class="sd">        and *not* from the basis set information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the dynamical matrix.</span>
<span class="sd">            By default this is ``[&quot;nc&quot;, &quot;FC&quot;]``.</span>
<span class="sd">        cutoff_dist : float, optional</span>
<span class="sd">            cutoff value for the distance of the force-constants (everything farther than</span>
<span class="sd">            `cutoff_dist` will be set to 0 Ang). Default, no cutoff.</span>
<span class="sd">        cutoff : float, optional</span>
<span class="sd">            absolute values below the cutoff are considered 0. Defaults to 0. eV/Ang**2.</span>
<span class="sd">        trans_inv : bool, optional</span>
<span class="sd">            if true (default), the force-constant matrix will be fixed so that translational</span>
<span class="sd">            invariance will be enforced</span>
<span class="sd">        sum0 : bool, optional</span>
<span class="sd">            if true (default), the sum of forces on atoms for each displacement will be</span>
<span class="sd">            forced to 0.</span>
<span class="sd">        hermitian: bool, optional</span>
<span class="sd">            if true (default), the returned dynamical matrix will be hermitian</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This is highly untested and may result in errorneous matrices.</span>
<span class="sd">        Please report back to developers about problems and suggestions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dynamic_matrix : DynamicalMatrix</span>
<span class="sd">            the dynamical matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;FC&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_dynamical_matrix_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">(read_dynamical_matrix) found in file=</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">.read_dynamical_matrix is experimental, untested!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_dynamical_matrix_fc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">FC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_hessian</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;FC&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">FC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># here we forcefully read the initial geometry.</span>
        <span class="c1"># The XV and other output files will likely contain shifted</span>
        <span class="c1"># coordinates.</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># The dynamical_matrix_from_fc should correctly specify the supercell</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">set_nsc</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">basis_fdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_basis</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;fdf&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">basis_fdf</span><span class="p">):</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>

        <span class="c1"># Get list of FC atoms</span>
        <span class="n">FC_atoms</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">arangei</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MD.FCFirst&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MD.FCLast&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">na</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamical_matrix_from_fc</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">FC</span><span class="p">,</span> <span class="n">FC_atoms</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_dynamical_matrix_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">FC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_hessian</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">FC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">])</span>
        <span class="c1"># The dynamical_matrix_from_fc should correctly specify the supercell</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">set_nsc</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">basis_fdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_basis</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;fdf&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">basis_fdf</span><span class="p">):</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>

        <span class="c1"># Get list of FC atoms</span>
        <span class="c1"># TODO change to read in from the NetCDF file</span>
        <span class="n">FC_atoms</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">arangei</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MD.FCFirst&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MD.FCLast&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">geom</span><span class="o">.</span><span class="n">na</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamical_matrix_from_fc</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">FC</span><span class="p">,</span> <span class="n">FC_atoms</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_dynamical_matrix_from_fc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">FC</span><span class="p">,</span> <span class="n">FC_atoms</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># We have the force constant matrix.</span>
        <span class="c1"># Now handle it...</span>
        <span class="c1">#  FC(OLD) = (n_displ, 3, 2, na, 3)</span>
        <span class="c1">#  FC(NEW) = (n_displ, 3, na, 3)</span>
        <span class="c1"># In fact, after averaging this becomes the Hessian</span>
        <span class="n">FC</span> <span class="o">=</span> <span class="n">FC</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">na_full</span> <span class="o">=</span> <span class="n">FC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">hermitian</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hermitian&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Figure out the &quot;original&quot; periodic directions</span>
        <span class="c1"># periodic = geom.nsc &gt; 1</span>

        <span class="c1"># Create conversion from eV/Ang^2 to correct units</span>
        <span class="c1"># Further down we are multiplying with [1 / amu]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">constant</span><span class="o">.</span><span class="n">hbar</span> <span class="o">/</span> <span class="n">units</span><span class="p">(</span><span class="s2">&quot;Ang&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">units</span><span class="p">(</span><span class="s2">&quot;eV amu&quot;</span><span class="p">,</span> <span class="s2">&quot;J kg&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

        <span class="c1"># Cut-off too small values</span>
        <span class="n">fc_cut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cutoff&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">FC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">FC</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">fc_cut</span><span class="p">,</span> <span class="n">FC</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Convert the force constant such that a diagonalization returns eV ^ 2</span>
        <span class="c1"># FC is in [eV / Ang^2]</span>

        <span class="c1"># Convert the geometry to contain 3 orbitals per atom (x, y, z)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cutoff_dist&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">orbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Orbital</span><span class="p">(</span><span class="n">R</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="s2">&quot;xyz&quot;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">geom</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">new_atom</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">orbs</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">atom</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">geom</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">new_atom</span><span class="p">)</span>

        <span class="c1"># Figure out the supercell indices</span>
        <span class="c1"># if the displaced atoms equals the length of the geometry</span>
        <span class="c1"># it means we are not using a supercell.</span>
        <span class="n">supercell</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;supercell&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">supercell</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">supercell</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">supercell</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">supercell</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">as_primary</span><span class="p">(</span><span class="n">FC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ret_super</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.read_dynamical_matrix(FC) guessed on a [</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">] &quot;</span>
                <span class="s2">&quot;supercell calculation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="o">*</span><span class="n">supercell</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Convert to integer array</span>
        <span class="n">supercell</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">asarrayi</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>

        <span class="c1"># Reshape to supercell</span>
        <span class="n">FC</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">FC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="n">supercell</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">na_fc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">FC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">FC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="o">//</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>

        <span class="c1"># Now we are in a problem since the tiling of the geometry</span>
        <span class="c1"># is not necessarily in x, y, z order.</span>
        <span class="c1"># Say for users who did:</span>
        <span class="c1">#   geom.tile(*, 2).tile(*, 1).tile(*, 0).write(...)</span>
        <span class="c1"># then we need to pivot the data to be consistent with the</span>
        <span class="c1"># supercell information</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">supercell</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Re-arange FC before we use _fc_correct</span>
            <span class="c1"># Now we need to figure out how the atoms are laid out.</span>
            <span class="c1"># It *MUST* either be repeated or tiled (preferentially tiled).</span>

            <span class="c1"># We have an actual supercell. Lets try and fix it.</span>
            <span class="c1"># First lets recreate the smallest geometry</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">supercell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">supercell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">supercell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Ensure nsc is at least an odd number, later down we will symmetrize the FC matrix</span>
            <span class="n">nsc</span> <span class="o">=</span> <span class="n">supercell</span> <span class="o">+</span> <span class="p">(</span><span class="n">supercell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Correct for the optional radius</span>
                <span class="n">sc_norm</span> <span class="o">=</span> <span class="n">fnorm</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="c1"># R is already &quot;twice&quot; the &quot;orbital&quot; range</span>
                <span class="n">nsc_R</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">R</span> <span class="o">/</span> <span class="n">sc_norm</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">nsc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nsc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nsc_R</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">nsc_R</span>

            <span class="c1"># Construct the minimal unit-cell geometry</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="n">Lattice</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">nsc</span><span class="o">=</span><span class="n">nsc</span><span class="p">)</span>
            <span class="c1"># TODO check that the coordinates are in the cell</span>
            <span class="n">geom_small</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">FC_atoms</span><span class="p">],</span> <span class="n">geom</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">FC_atoms</span><span class="p">],</span> <span class="n">lattice</span><span class="p">)</span>

            <span class="c1"># Convert the big geometry&#39;s coordinates to fractional coordinates of the small unit-cell.</span>
            <span class="n">isc_xyz</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">geom_small</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">icell</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                <span class="n">geom_small</span><span class="o">.</span><span class="n">fxyz</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">supercell</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">axis_tiling</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">geom_small</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">supercell</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">first_isc</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">isc_xyz</span><span class="p">[</span><span class="n">FC_atoms</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="p">:])</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">axis_tiling</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">first_isc</span><span class="p">))</span>
                <span class="c1"># Fix the offset and wrap-around</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="n">supercell</span><span class="p">[</span><span class="n">axis_tiling</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">%</span> <span class="n">na_full</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axis_tiling</span><span class="p">:</span>
                    <span class="n">axis_tiling</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Now we have the tiling operation, check it sort of matches</span>
            <span class="n">geom_tile</span> <span class="o">=</span> <span class="n">geom_small</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axis_tiling</span><span class="p">:</span>
                <span class="n">geom_tile</span> <span class="o">=</span> <span class="n">geom_tile</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">supercell</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">axis</span><span class="p">)</span>

            <span class="c1"># Proximity check of 0.01 Ang (TODO add this as an argument)</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">daxis</span> <span class="o">=</span> <span class="n">geom_tile</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">]</span> <span class="o">-</span> <span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span> <span class="n">ax</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">daxis</span><span class="p">,</span> <span class="n">daxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">SislError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2">.read_dynamical_matrix(FC) could &quot;</span>
                        <span class="s2">&quot;not figure out the tiling method for the supercell&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Convert the FC matrix to a &quot;rollable&quot; matrix</span>
            <span class="c1"># This will make it easier to symmetrize</span>
            <span class="c1">#  0. displaced atoms</span>
            <span class="c1">#  1. x, y, z (displacements)</span>
            <span class="c1">#  2. tile-axis_tiling[0]</span>
            <span class="c1">#  3. tile-axis_tiling[1]</span>
            <span class="c1">#  4. tile-axis_tiling[2]</span>
            <span class="c1">#  5. na</span>
            <span class="c1">#  6. x, y, z (force components)</span>
            <span class="c1"># order of FC is reversed of the axis_tiling (because of contiguous arrays)</span>
            <span class="c1"># so reverse</span>
            <span class="n">axis_tiling</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">FC</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">na_fc</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="n">supercell</span><span class="p">[</span><span class="n">axis_tiling</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># now ensure we have the correct order of the supercell</span>
            <span class="c1"># If the input supercell is</span>
            <span class="c1"># [-2] [-1] [0] [1] [2]</span>
            <span class="c1"># we need to convert it to</span>
            <span class="c1">#  [0] [1] [2] [3] [4] [5]</span>
            <span class="n">isc_xyz</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">supercell</span><span class="p">[</span><span class="n">axis_tiling</span><span class="p">],</span> <span class="n">na_fc</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axis_tiling</span><span class="p">:</span>
                <span class="n">nroll</span> <span class="o">=</span> <span class="n">isc_xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">inroll</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">nroll</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">inroll</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># offset axis by 2 due to (na_fc, 3, ...)</span>
                    <span class="n">FC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">FC</span><span class="p">,</span> <span class="n">inroll</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">FC_atoms</span> <span class="o">-=</span> <span class="n">FC_atoms</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="c1"># Now swap the [2, 3, 4] dimensions so that we get in order of lattice vectors</span>
            <span class="c1">#  x, y, z</span>
            <span class="n">FC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                <span class="n">FC</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">axis_tiling</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">del</span> <span class="n">axis_tiling</span>
            <span class="c1"># Now FC is sorted according to the supercell tiling</span>

        <span class="c1"># TODO this will probably fail if: FC_atoms.size != FC.shape[5]</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">._help</span><span class="w"> </span><span class="kn">import</span> <span class="n">_fc_correct</span>

        <span class="n">FC</span> <span class="o">=</span> <span class="n">_fc_correct</span><span class="p">(</span>
            <span class="n">FC</span><span class="p">,</span>
            <span class="n">trans_inv</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trans_inv&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">sum0</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sum0&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">hermitian</span><span class="o">=</span><span class="n">hermitian</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Remove ghost-atoms or atoms with 0 mass!</span>
        <span class="c1"># TODO check if ghost-atoms should be taken into account in _fc_correct</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># FC = np.delete(FC, idx, axis=5)</span>
            <span class="c1"># geom = geom.remove(idx)</span>
            <span class="c1"># geom.set_nsc([1] * 3)</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">.read_dynamical_matrix could not reduce geometry &quot;</span>
                <span class="s2">&quot;since there are atoms with 0 mass.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Now we can build the dynamical matrix (it will always be real)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">supercell</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># also catches supercell == 0</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="n">geom</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">no</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

            <span class="n">FC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">FC</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="c1"># Instead of doing the sqrt in all D = FC (below) we do it here</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">/</span> <span class="n">geom</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">mass</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">FC</span> <span class="o">*=</span> <span class="n">m</span><span class="p">[</span><span class="n">FC_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">j_FC_atoms</span> <span class="o">=</span> <span class="n">FC_atoms</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">arangei</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">fia</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># find distances between the other atoms to cut-off the distance</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fia</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">FC_atoms</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">indices_only</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                    <span class="n">j_FC_atoms</span> <span class="o">=</span> <span class="n">FC_atoms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">ja</span><span class="p">,</span> <span class="n">fja</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">j_FC_atoms</span><span class="p">):</span>
                    <span class="n">D</span><span class="p">[</span><span class="n">ia</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">:</span> <span class="p">(</span><span class="n">ia</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ja</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">:</span> <span class="p">(</span><span class="n">ja</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">FC</span><span class="p">[</span><span class="n">ia</span><span class="p">,</span> <span class="p">:,</span> <span class="n">fja</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">geom_small</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SislError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">.read_dynamical_matrix(FC) requires the FC atoms to be consecutive!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Re-order FC matrix so the FC-atoms are first</span>
            <span class="k">if</span> <span class="n">FC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">FC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
                <span class="n">ordered</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">arangei</span><span class="p">(</span><span class="n">FC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ordered</span><span class="p">,</span> <span class="n">FC_atoms</span><span class="p">))</span>
                <span class="n">FC</span> <span class="o">=</span> <span class="n">FC</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ordered</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">FC_atoms</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">arangei</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">FC_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># TODO we could roll the axis such that the displaced atoms moves into the</span>
                <span class="c1"># first elements</span>
                <span class="k">raise</span> <span class="n">SislError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">.read_dynamical_matrix(FC) requires the displaced atoms to start from 1!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># After having done this we can easily mass scale all FC components</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">/</span> <span class="n">geom</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">mass</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">FC</span> <span class="o">*=</span> <span class="n">m</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Check whether we need to &quot;halve&quot; the equivalent supercell</span>
            <span class="c1"># This will be present in calculations done on an even number of supercells.</span>
            <span class="c1"># I.e. for 4 supercells</span>
            <span class="c1">#  [0] [1] [2] [3]</span>
            <span class="c1"># where in the supercell approach:</span>
            <span class="c1">#  *[2] [3] [0] [1] *[2]</span>
            <span class="c1"># I.e. since we are double counting [2] we will halve it.</span>
            <span class="c1"># This is not *exactly* true because depending on the range one should do the symmetry operations.</span>
            <span class="c1"># However the FC does not contain such symmetry considerations.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">supercell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># We don&#39;t need to do anything</span>
                    <span class="k">continue</span>

                <span class="c1"># Figure out the supercell to halve</span>
                <span class="n">halve_idx</span> <span class="o">=</span> <span class="n">supercell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">FC</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">halve_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="mf">0.5</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">FC</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">halve_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="mf">0.5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">FC</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">halve_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="mf">0.5</span>

            <span class="c1"># Now create the dynamical matrix</span>
            <span class="c1"># Currently this will be in lil_matrix (changed in the end)</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="n">geom</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">no_s</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

            <span class="c1"># When x, y, z are negative we simply look-up from the back of the array</span>
            <span class="c1"># which is exactly what is required</span>
            <span class="n">isc_off</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">isc_off</span>
            <span class="n">nxyz</span><span class="p">,</span> <span class="n">na</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">na</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">rij</span>

            <span class="c1"># Now take all positive supercell connections (including inner cell)</span>
            <span class="n">nsc</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">nsc</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">list_nsc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nsc</span><span class="p">]</span>

            <span class="n">iter_FC_atoms</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">arangei</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FC_atoms</span><span class="p">))</span>
            <span class="n">iter_j_FC_atoms</span> <span class="o">=</span> <span class="n">iter_FC_atoms</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">itools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">list_nsc</span><span class="p">):</span>
                <span class="n">isc</span> <span class="o">=</span> <span class="n">isc_off</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
                <span class="n">aoff</span> <span class="o">=</span> <span class="n">isc</span> <span class="o">*</span> <span class="n">na</span>
                <span class="n">joff</span> <span class="o">=</span> <span class="n">isc</span> <span class="o">*</span> <span class="n">nxyz</span>
                <span class="k">for</span> <span class="n">ia</span> <span class="ow">in</span> <span class="n">iter_FC_atoms</span><span class="p">:</span>
                    <span class="c1"># Reduce second loop based on radius cutoff</span>
                    <span class="k">if</span> <span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">iter_j_FC_atoms</span> <span class="o">=</span> <span class="n">iter_FC_atoms</span><span class="p">[</span>
                            <span class="n">dist</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">aoff</span> <span class="o">+</span> <span class="n">iter_FC_atoms</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">R</span>
                        <span class="p">]</span>

                    <span class="k">for</span> <span class="n">ja</span> <span class="ow">in</span> <span class="n">iter_j_FC_atoms</span><span class="p">:</span>
                        <span class="n">D</span><span class="p">[</span>
                            <span class="n">ia</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">:</span> <span class="p">(</span><span class="n">ia</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">joff</span> <span class="o">+</span> <span class="n">ja</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">:</span> <span class="n">joff</span> <span class="o">+</span> <span class="p">(</span><span class="n">ja</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
                        <span class="p">]</span> <span class="o">+=</span> <span class="n">FC</span><span class="p">[</span><span class="n">ia</span><span class="p">,</span> <span class="p">:,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ja</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># The mass-scaling wass added to the FC components</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
        <span class="c1"># Remove all zeros</span>
        <span class="n">D</span><span class="o">.</span><span class="n">eliminate_zeros</span><span class="p">()</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">DynamicalMatrix</span><span class="o">.</span><span class="n">fromsp</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hermitian</span><span class="p">:</span>
            <span class="n">D</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
            <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span> <span class="o">+</span> <span class="n">D</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="k">return</span> <span class="n">D</span>

<div class="viewcode-block" id="fdfSileSiesta.read_geometry">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_geometry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Geometry</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns Geometry object by reading fdf or Siesta output related files.</span>

<span class="sd">        One can limit the tried files to only one file by passing</span>
<span class="sd">        only a single file ending.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output:</span>
<span class="sd">            whether to read geometry from output files (default to read from</span>
<span class="sd">            the fdf file).</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the geometry.</span>
<span class="sd">            By default this is ``[XV, nc, TSHS, STRUCT, HSX, fdf]`` if `output` is true</span>
<span class="sd">            If `order` is present `output` is disregarded.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; fdf = get_sile(&quot;RUN.fdf&quot;)</span>
<span class="sd">        &gt;&gt;&gt; fdf.read_geometry() # read from fdf</span>
<span class="sd">        &gt;&gt;&gt; fdf.read_geometry(True) # read from [XV, nc, fdf]</span>
<span class="sd">        &gt;&gt;&gt; fdf.read_geometry(order=[&quot;nc&quot;]) # read from [nc]</span>
<span class="sd">        &gt;&gt;&gt; fdf.read_geometry(True, order=[&quot;nc&quot;]) # read from [nc]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">##</span>
        <span class="c1"># NOTE</span>
        <span class="c1"># When adding more capabilities please check the read_geometry(order=...) in this</span>
        <span class="c1"># code to correct.</span>
        <span class="c1">##</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;XV&quot;</span><span class="p">,</span> <span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;TSHS&quot;</span><span class="p">,</span> <span class="s2">&quot;STRUCT&quot;</span><span class="p">,</span> <span class="s2">&quot;HSX&quot;</span><span class="p">,</span> <span class="s2">&quot;fdf&quot;</span><span class="p">],</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;fdf&quot;</span><span class="p">},</span>
            <span class="n">output</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_geometry_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_geometry_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AtomicCoordinatesAndAtomicSpecies&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
        <span class="k">if</span> <span class="n">species</span><span class="p">:</span>
            <span class="n">na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NumberOfAtoms&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">))</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">fromiteri</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">],</span> <span class="n">species</span><span class="p">[:</span><span class="n">na</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">species</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_geometry_xv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns `Geometry` object from the XV file&quot;&quot;&quot;</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.XV&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_geometry_xv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_basis</span><span class="p">()</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">xvSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span>
            <span class="n">nsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_lattice_nsc</span><span class="p">()</span>
            <span class="n">geom</span><span class="o">.</span><span class="n">set_nsc</span><span class="p">(</span><span class="n">nsc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">geom</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_geometry_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns `Geometry` object from the STRUCT_* files&quot;&quot;&quot;</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;STRUCT_NEXT_ITER&quot;</span><span class="p">,</span> <span class="s2">&quot;STRUCT_OUT&quot;</span><span class="p">,</span> <span class="s2">&quot;STRUCT_IN&quot;</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_geometry_struct</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_basis</span><span class="p">()</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">structSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">basis</span><span class="p">)</span>
                <span class="n">nsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_lattice_nsc</span><span class="p">()</span>
                <span class="n">geom</span><span class="o">.</span><span class="n">set_nsc</span><span class="p">(</span><span class="n">nsc</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">geom</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_geometry_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read geometry from &lt;&gt;.nc file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_geometry_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_geometry_tshs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read geometry from &lt;&gt;.TSHS file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSHS&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_geometry_tshs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.HS.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="c1"># Default to a geometry with the correct atomic numbers etc.</span>
            <span class="k">return</span> <span class="n">tshsSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_basis</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_geometry_hsx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read geometry from &lt;&gt;.TSHS file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.HSX&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_geometry_hsx</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;Save.HS&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="c1"># Default to a geometry with the correct atomic numbers etc.</span>
            <span class="k">return</span> <span class="n">hsxSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span>
                <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;^hsx&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_geometry_fdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns Geometry object from the FDF file</span>

<span class="sd">        NOTE: Interaction range of the Atoms are currently not read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_lattice</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;fdf&quot;</span><span class="p">)</span>

        <span class="c1"># No fractional coordinates</span>
        <span class="n">is_frac</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Read atom scaling</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AtomicCoordinatesFormat&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Bohr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;ang&quot;</span> <span class="ow">in</span> <span class="n">lc</span> <span class="ow">or</span> <span class="s2">&quot;notscaledcartesianang&quot;</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="s2">&quot;bohr&quot;</span> <span class="ow">in</span> <span class="n">lc</span> <span class="ow">or</span> <span class="s2">&quot;notscaledcartesianbohr&quot;</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Bohr2Ang</span>
        <span class="k">elif</span> <span class="s2">&quot;scaledcartesian&quot;</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">:</span>
            <span class="c1"># the same scaling as the lattice-vectors</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LatticeConstant&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Ang&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;fractional&quot;</span> <span class="ow">in</span> <span class="n">lc</span> <span class="ow">or</span> <span class="s2">&quot;scaledbylatticevectors&quot;</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">:</span>
            <span class="c1"># no scaling of coordinates as that is entirely</span>
            <span class="c1"># done by the latticevectors</span>
            <span class="n">s</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">is_frac</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If the user requests a shifted geometry</span>
        <span class="c1"># we correct for this</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">zerosd</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">lor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AtomicCoordinatesOrigin&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lor</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">lor</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">asarrayd</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])))</span> <span class="o">*</span> <span class="n">s</span>
        <span class="c1"># Origin cannot be interpreted with fractional coordinates</span>
        <span class="c1"># hence, it is not transformed.</span>

        <span class="c1"># Read atom block</span>
        <span class="n">atms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AtomicCoordinatesAndAtomicSpecies&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">atms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SileError</span><span class="p">(</span>
                <span class="s2">&quot;AtomicCoordinatesAndAtomicSpecies block could not be found&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Read number of atoms and block</span>
        <span class="c1"># We default to the number of elements in the</span>
        <span class="c1"># AtomicCoordinatesAndAtomicSpecies block</span>
        <span class="n">na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NumberOfAtoms&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">atms</span><span class="p">))</span>

        <span class="c1"># Reduce space if number of atoms specified</span>
        <span class="k">if</span> <span class="n">na</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">atms</span><span class="p">):</span>
            <span class="c1"># align number of atoms and atms array</span>
            <span class="n">atms</span> <span class="o">=</span> <span class="n">atms</span><span class="p">[:</span><span class="n">na</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">na</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">atms</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SileError</span><span class="p">(</span>
                <span class="s2">&quot;NumberOfAtoms is larger than the atoms defined in the blocks&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">na</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SileError</span><span class="p">(</span><span class="s2">&quot;NumberOfAtoms has been determined to be zero, no atoms.&quot;</span><span class="p">)</span>

        <span class="c1"># Create array</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">emptyd</span><span class="p">([</span><span class="n">na</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">_a</span><span class="o">.</span><span class="n">emptyi</span><span class="p">([</span><span class="n">na</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ia</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">na</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">atms</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">xyz</span><span class="p">[</span><span class="n">ia</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
            <span class="n">species</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">is_frac</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">*=</span> <span class="n">s</span>

        <span class="c1"># Read the block (not strictly needed, if so we simply set all atoms to H)</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_basis</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Block ChemicalSpeciesLabel does not exist, cannot determine the basis (all will be their species indices).&quot;</span>
            <span class="p">)</span>
            <span class="c1"># the following call will then make use of this object</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="n">species</span>

        <span class="c1"># Default atoms are the species indices... Basically unknown</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">_fill_basis_empty</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">origin</span>
            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cop&quot;</span><span class="p">):</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;com&quot;</span><span class="p">):</span>
                <span class="c1"># TODO for ghost atoms its mass should not be used</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">mass</span>
                <span class="n">w</span> <span class="o">/=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">):</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
                    <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                    <span class="n">origin</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span>
                    <span class="n">origin</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;xy&quot;</span><span class="p">,</span> <span class="s2">&quot;yx&quot;</span><span class="p">):</span>
                    <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;xz&quot;</span><span class="p">,</span> <span class="s2">&quot;zx&quot;</span><span class="p">):</span>
                    <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;yz&quot;</span><span class="p">,</span> <span class="s2">&quot;zy&quot;</span><span class="p">):</span>
                    <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># create geometry</span>
        <span class="n">xyz</span> <span class="o">+=</span> <span class="n">origin</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">)</span>

        <span class="c1"># and finally check for supercell constructs</span>
        <span class="n">supercell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Lattice&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">supercell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># we need to expand</span>
            <span class="c1"># check that we are only dealing with an orthogonal supercell</span>
            <span class="n">supercell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">supercell</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">supercell</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Check it is diagonal</span>
            <span class="n">diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">supercell</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diag</span><span class="p">),</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SileError</span><span class="p">(</span>
                    <span class="s2">&quot;Lattice input is not diagonal, currently not implemented in sisl&quot;</span>
                <span class="p">)</span>

            <span class="c1"># now tile it</span>
            <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">nt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diag</span><span class="p">):</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">geom</span>

<div class="viewcode-block" id="fdfSileSiesta.read_grid">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Grid</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read grid related information from any of the output files</span>

<span class="sd">        The order of the readed data is shown below.</span>

<span class="sd">        One can limit the tried files to only one file by passing</span>
<span class="sd">        only a single file ending.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name :</span>
<span class="sd">            name of data to read. The list of names correspond to the</span>
<span class="sd">            Siesta output manual (Rho, TotalPotential, etc.), the strings are</span>
<span class="sd">            case insensitive.</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the geometry.</span>
<span class="sd">            By default this is ``[&quot;nc&quot;, &quot;grid.nc&quot;, &quot;bin&quot;]`` (bin refers to the binary files)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;grid.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_grid_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span>
                <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_grid_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Read grid from the &lt;&gt;.nc file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_grid_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="c1"># Capitalize correctly</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;rho&quot;</span><span class="p">:</span> <span class="s2">&quot;Rho&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rhoinit&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoInit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;vna&quot;</span><span class="p">:</span> <span class="s2">&quot;Vna&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ioch&quot;</span><span class="p">:</span> <span class="s2">&quot;Chlocal&quot;</span><span class="p">,</span>
                <span class="s2">&quot;chlocal&quot;</span><span class="p">:</span> <span class="s2">&quot;Chlocal&quot;</span><span class="p">,</span>
                <span class="s2">&quot;toch&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoTot&quot;</span><span class="p">,</span>
                <span class="s2">&quot;totalcharge&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoTot&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rhotot&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoTot&quot;</span><span class="p">,</span>
                <span class="s2">&quot;drho&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoDelta&quot;</span><span class="p">,</span>
                <span class="s2">&quot;deltarho&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoDelta&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rhodelta&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoDelta&quot;</span><span class="p">,</span>
                <span class="s2">&quot;vh&quot;</span><span class="p">:</span> <span class="s2">&quot;Vh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;electrostaticpotential&quot;</span><span class="p">:</span> <span class="s2">&quot;Vh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rhoxc&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoXC&quot;</span><span class="p">,</span>
                <span class="s2">&quot;vt&quot;</span><span class="p">:</span> <span class="s2">&quot;Vt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;totalpotential&quot;</span><span class="p">:</span> <span class="s2">&quot;Vt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bader&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoBader&quot;</span><span class="p">,</span>
                <span class="s2">&quot;baderrho&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoBader&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rhobader&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoBader&quot;</span><span class="p">,</span>
            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_grid</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_grid_grid_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Read grid from the &lt;&gt;.nc file</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rho&quot;</span><span class="p">:</span> <span class="s2">&quot;Rho&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhoinit&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoInit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vna&quot;</span><span class="p">:</span> <span class="s2">&quot;Vna&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ioch&quot;</span><span class="p">:</span> <span class="s2">&quot;Chlocal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chlocal&quot;</span><span class="p">:</span> <span class="s2">&quot;Chlocal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;toch&quot;</span><span class="p">:</span> <span class="s2">&quot;TotalCharge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;totalcharge&quot;</span><span class="p">:</span> <span class="s2">&quot;TotalCharge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhotot&quot;</span><span class="p">:</span> <span class="s2">&quot;TotalCharge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;drho&quot;</span><span class="p">:</span> <span class="s2">&quot;DeltaRho&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deltarho&quot;</span><span class="p">:</span> <span class="s2">&quot;DeltaRho&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhodelta&quot;</span><span class="p">:</span> <span class="s2">&quot;DeltaRho&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vh&quot;</span><span class="p">:</span> <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">,</span>
            <span class="s2">&quot;electrostaticpotential&quot;</span><span class="p">:</span> <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhoxc&quot;</span><span class="p">:</span> <span class="s2">&quot;RhoXC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vt&quot;</span><span class="p">:</span> <span class="s2">&quot;TotalPotential&quot;</span><span class="p">,</span>
            <span class="s2">&quot;totalpotential&quot;</span><span class="p">:</span> <span class="s2">&quot;TotalPotential&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bader&quot;</span><span class="p">:</span> <span class="s2">&quot;BaderCharge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;baderrho&quot;</span><span class="p">:</span> <span class="s2">&quot;BaderCharge&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhobader&quot;</span><span class="p">:</span> <span class="s2">&quot;BaderCharge&quot;</span><span class="p">,</span>
        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;.grid.nc&quot;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_grid_grid_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">gridncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_grid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">grid</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_grid_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Read grid from the &lt;&gt;.VT/... file</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rho&quot;</span><span class="p">:</span> <span class="s2">&quot;.RHO&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhoinit&quot;</span><span class="p">:</span> <span class="s2">&quot;.RHOINIT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vna&quot;</span><span class="p">:</span> <span class="s2">&quot;.VNA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ioch&quot;</span><span class="p">:</span> <span class="s2">&quot;.IOCH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chlocal&quot;</span><span class="p">:</span> <span class="s2">&quot;.IOCH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;toch&quot;</span><span class="p">:</span> <span class="s2">&quot;.TOCH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;totalcharge&quot;</span><span class="p">:</span> <span class="s2">&quot;.TOCH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhotot&quot;</span><span class="p">:</span> <span class="s2">&quot;.TOCH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;drho&quot;</span><span class="p">:</span> <span class="s2">&quot;.DRHO&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deltarho&quot;</span><span class="p">:</span> <span class="s2">&quot;.DRHO&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhodelta&quot;</span><span class="p">:</span> <span class="s2">&quot;.DRHO&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vh&quot;</span><span class="p">:</span> <span class="s2">&quot;.VH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;electrostaticpotential&quot;</span><span class="p">:</span> <span class="s2">&quot;.VH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhoxc&quot;</span><span class="p">:</span> <span class="s2">&quot;.RHOXC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vt&quot;</span><span class="p">:</span> <span class="s2">&quot;.VT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;totalpotential&quot;</span><span class="p">:</span> <span class="s2">&quot;.VT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bader&quot;</span><span class="p">:</span> <span class="s2">&quot;.BADER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;baderrho&quot;</span><span class="p">:</span> <span class="s2">&quot;.BADER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rhobader&quot;</span><span class="p">:</span> <span class="s2">&quot;.BADER&quot;</span><span class="p">,</span>
        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_grid_bin</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">get_sile_class</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_grid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">grid</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="fdfSileSiesta.read_basis">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_basis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the atomic species and figure out the number of atomic orbitals in their basis</span>

<span class="sd">        The order of the read is shown below.</span>

<span class="sd">        One can limit the tried files to only one file by passing</span>
<span class="sd">        only a single file ending.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the basis information.</span>
<span class="sd">            By default this is ``[&quot;nc&quot;, &quot;ion&quot;, &quot;ORB_INDX&quot;, &quot;HSX&quot;, &quot;fdf&quot;]``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;ion&quot;</span><span class="p">,</span> <span class="s2">&quot;ORB_INDX&quot;</span><span class="p">,</span> <span class="s2">&quot;HSX&quot;</span><span class="p">,</span> <span class="s2">&quot;fdf&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_basis_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">(read_basis) found in file=</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_basis_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read basis from &lt;&gt;.nc file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_basis_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_basis</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_basis_ion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read basis from &lt;&gt;.ion.nc file or &lt;&gt;.ion.xml</span>
        <span class="n">spcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ChemicalSpeciesLabel&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We haven&quot;t found the chemical and species label</span>
            <span class="c1"># so return nothing</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">exts</span> <span class="o">=</span> <span class="n">_order_remove_netcdf</span><span class="p">([</span><span class="s2">&quot;ion.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;ion.xml&quot;</span><span class="p">])</span>
        <span class="n">ion_files</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ion.nc&quot;</span><span class="p">:</span> <span class="n">ionncSileSiesta</span><span class="p">,</span>
            <span class="s2">&quot;ion.xml&quot;</span><span class="p">:</span> <span class="n">ionxmlSileSiesta</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Now spcs contains the block of the chemicalspecieslabel</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spcs</span><span class="p">)</span>
        <span class="n">found_one</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="n">spcs</span><span class="p">:</span>
            <span class="n">idx</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">lbl</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># F-indexing</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
            <span class="n">lbl</span> <span class="o">=</span> <span class="n">lbl</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="n">lbl</span> <span class="o">+</span> <span class="s2">&quot;.ext&quot;</span><span class="p">)</span>

            <span class="c1"># now try and read the basis</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
                <span class="n">ion</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_basis_ion</span><span class="p">,</span> <span class="n">ion</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ion</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">atoms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ion_files</span><span class="p">[</span><span class="n">ext</span><span class="p">](</span><span class="n">ion</span><span class="p">)</span><span class="o">.</span><span class="n">read_basis</span><span class="p">()</span>
                    <span class="n">found_one</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># default the atom to not have a range, and no associated orbitals</span>
                <span class="n">atoms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">lbl</span><span class="p">)</span>
                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">found_one</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">found_all</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Siesta basis information could not read all ion.nc/ion.xml files. &quot;</span>
                <span class="s2">&quot;Only a subset of the basis information is accessible.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">found_one</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_geometry_species</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_fill_basis_empty</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>
        <span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2"> does not contain the AtomicCoordinatesAndAtomicSpecies block, basis set definition may not contain all atoms.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_basis_orb_indx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ORB_INDX&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_basis_orb_indx</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;Write.OrbitalIndex&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Siesta basis information is read from &#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&#39;; radial functions are not accessible.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">orbindxSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_basis</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_basis_fdf</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_basis_hsx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.HSX&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_basis_hsx</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;Save.HS&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;atoms&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="c1"># to ensure we get the correct orbital count</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;atoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_basis</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;^hsx&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hsxSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_basis</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_basis_fdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read basis from fdf file</span>
        <span class="n">spcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ChemicalSpeciesLabel&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We haven&quot;t found the chemical and species label</span>
            <span class="c1"># so return nothing</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># We create a dictionary with the different atomic species</span>
        <span class="c1"># and create defaults with another dictionary.</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">spcs</span><span class="p">]</span>

        <span class="n">pao_basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PAO.Basis&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>

        <span class="n">all_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AtomicMass&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
        <span class="c1"># default mass</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Now spcs contains the block of the chemicalspecieslabel</span>
        <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="n">spcs</span><span class="p">:</span>
            <span class="n">idx</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># F-indexing</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_mass</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">mass_line</span> <span class="ow">in</span> <span class="n">all_mass</span><span class="p">:</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">mass</span> <span class="o">=</span> <span class="n">mass_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">idx</span><span class="p">:</span>
                        <span class="n">mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mass</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">atom</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="n">Z</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">mass</span><span class="p">,</span> <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">tag</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Only in some cases can we parse the PAO.Basis block.</span>
                <span class="c1"># There are many corner cases where we can&#39;t parse it</span>
                <span class="c1"># And the we just don&#39;t do anything...</span>
                <span class="c1"># We don&#39;t even warn the user...</span>
                <span class="n">atom</span><span class="p">[</span><span class="s2">&quot;orbitals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_pao_basis</span><span class="p">(</span><span class="n">pao_basis</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">atoms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="o">**</span><span class="n">atom</span><span class="p">)</span>

        <span class="c1"># retrieve the atomic species (from the AtomicCoordinatesAndSpecies block)</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_geometry_species</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_fill_basis_empty</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>

        <span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2"> does not contain the AtomicCoordinatesAndAtomicSpecies block, basis set definition may not contain all atoms.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_pao_basis</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the full PAO.Basis block with *optionally* only a single specie</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This parsing of the basis set is not complete, in any sense.</span>
<span class="sd">        Especially if users requests filtered orbitals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        block : list of str or str</span>
<span class="sd">           the entire PAO.Basis block as read by ``self.get(&quot;PAO.Basis&quot;)``</span>
<span class="sd">        species : str, optional</span>
<span class="sd">           which species to parse</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        orbitals : list of AtomicOrbital</span>
<span class="sd">            only if requested `species` is not None</span>
<span class="sd">        tag_orbitals : dict</span>
<span class="sd">            if `species` is None then a dictionary is returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

        <span class="c1"># Quick exit if needed</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">specie</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># make a copy</span>
        <span class="n">block</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">blockline</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">block</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">out</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n\r\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parse_next</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">blockline</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">blockline</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># In this basis parser we don&#39;t care about the options for</span>
            <span class="c1"># the specifications</span>
            <span class="n">tag</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="c1"># now loop orbitals</span>
            <span class="n">orbs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># we just use a non-physical number to signal it didn&#39;t get added</span>
            <span class="c1"># in siesta it can automatically determine this, we can&#39;t... (yet!)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nl</span><span class="p">)):</span>
                <span class="c1"># we have 2 or 3 lines</span>
                <span class="n">nl_line</span> <span class="o">=</span> <span class="n">blockline</span><span class="p">()</span>
                <span class="n">rc_line</span> <span class="o">=</span> <span class="n">blockline</span><span class="p">()</span>
                <span class="c1"># check if we have contraction in the line</span>
                <span class="c1"># This is not perfect, but should grab</span>
                <span class="c1"># contration lines rather than next orbital line.</span>
                <span class="c1"># This is because the first n=&lt;integer&gt; should never</span>
                <span class="c1"># contain a &quot;.&quot;, whereas the contraction *should*.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">contract_line</span> <span class="o">=</span> <span class="n">blockline</span><span class="p">()</span>

                <span class="c1"># remove n=</span>
                <span class="n">nl_line</span> <span class="o">=</span> <span class="n">nl_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;n=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                <span class="c1"># first 3|2: are n?, l, Nzeta</span>
                <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># use default n defined in AtomitOrbital</span>
                <span class="n">first</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nl_line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">second</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nl_line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">nl_line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">first</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">second</span>
                    <span class="n">nzeta</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nl_line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">first</span>
                    <span class="n">nzeta</span> <span class="o">=</span> <span class="n">second</span>

                <span class="c1"># Number of polarizations</span>
                <span class="n">npol</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nl_line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="n">nl_line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">npol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nl_line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">nl_line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">npol</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># now we have everything to build the orbitals etc.</span>
                <span class="n">first_zeta</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">izeta</span><span class="p">,</span> <span class="n">rc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">rc_line</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rc</span> <span class="o">*=</span> <span class="n">Bohr2Ang</span>
                    <span class="k">elif</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="n">orbs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">R</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rc</span> <span class="o">*=</span> <span class="o">-</span><span class="n">orbs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">R</span>
                    <span class="n">orb</span> <span class="o">=</span> <span class="n">SphericalOrbital</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">rc</span><span class="p">)</span>
                    <span class="n">orbs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">toAtomicOrbital</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">zeta</span><span class="o">=</span><span class="n">izeta</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">izeta</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">first_zeta</span> <span class="o">=</span> <span class="n">orb</span>
                    <span class="n">nzeta</span> <span class="o">-=</span> <span class="mi">1</span>

                <span class="c1"># In case the final orbitals hasn&#39;t been defined.</span>
                <span class="c1"># They really should be defined in this one, but sometimes it may be</span>
                <span class="c1"># useful to leave the rc&#39;s definitions out.</span>
                <span class="n">orb</span> <span class="o">=</span> <span class="n">orbs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">R</span>
                <span class="k">for</span> <span class="n">izeta</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">zeta</span><span class="p">,</span> <span class="n">orb</span><span class="o">.</span><span class="n">zeta</span> <span class="o">+</span> <span class="n">nzeta</span><span class="p">):</span>
                    <span class="n">orb</span> <span class="o">=</span> <span class="n">SphericalOrbital</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">rc</span><span class="p">)</span>
                    <span class="n">orbs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">toAtomicOrbital</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">zeta</span><span class="o">=</span><span class="n">izeta</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">npol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">orb</span> <span class="o">=</span> <span class="n">SphericalOrbital</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">first_zeta</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
                    <span class="n">orbs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">toAtomicOrbital</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">zeta</span><span class="o">=</span><span class="n">ipol</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">tag</span><span class="p">,</span> <span class="n">orbs</span>

        <span class="n">tag_orbs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">parse_next</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tag_orbs</span><span class="p">[</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">parse_next</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">species</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tag_orbs</span>
        <span class="k">return</span> <span class="n">tag_orbs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_add_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_call</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal routine to ensure that the overlap matrix is read and added to the matrix `M`&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_overlap</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">M</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>
            <span class="c1"># Check for the same sparsity pattern</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">_csr</span><span class="o">.</span><span class="n">col</span> <span class="o">==</span> <span class="n">S</span><span class="o">.</span><span class="n">_csr</span><span class="o">.</span><span class="n">col</span><span class="p">):</span>
                <span class="n">M</span><span class="o">.</span><span class="n">_csr</span><span class="o">.</span><span class="n">_D</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">_csr</span><span class="o">.</span><span class="n">_D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2"> could not succesfully read the overlap matrix in </span><span class="si">{</span><span class="n">parent_call</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="fdfSileSiesta.read_density_matrix">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_density_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_density_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DensityMatrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try and read density matrix by reading the &lt;&gt;.nc, &lt;&gt;.TSDE files, &lt;&gt;.DM (in that order)</span>

<span class="sd">        One can limit the tried files to only one file by passing</span>
<span class="sd">        only a single file ending.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the density matrix</span>
<span class="sd">            By default this is ``[&quot;nc&quot;, &quot;TSDE&quot;, &quot;DM&quot;]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;TSDE&quot;</span><span class="p">,</span> <span class="s2">&quot;DM&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">DM</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_density_matrix_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">DM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DM</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_density_matrix_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try and read the density matrix by reading the &lt;&gt;.nc&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_density_matrix_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="n">DM</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="c1"># this *should* also contain the overlap matrix</span>
            <span class="n">DM</span> <span class="o">=</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_density_matrix</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DM</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_density_matrix_tsde</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read density matrix from the TSDE file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSDE&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_density_matrix_tsde</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.DE.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="n">DM</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="c1"># to ensure we get the correct orbital count</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DM</span> <span class="o">=</span> <span class="n">tsdeSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_density_matrix</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_r_add_overlap</span><span class="p">(</span><span class="s2">&quot;_r_density_matrix_tsde&quot;</span><span class="p">,</span> <span class="n">DM</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DM</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_density_matrix_dm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read density matrix from the DM file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.DM&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_density_matrix_dm</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">DM</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="c1"># to ensure we get the correct orbital count</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">DM</span> <span class="o">=</span> <span class="n">dmSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_density_matrix</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_r_add_overlap</span><span class="p">(</span><span class="s2">&quot;_r_density_matrix_dm&quot;</span><span class="p">,</span> <span class="n">DM</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DM</span>

<div class="viewcode-block" id="fdfSileSiesta.read_energy_density_matrix">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_energy_density_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_energy_density_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyDensityMatrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try and read energy density matrix by reading the &lt;&gt;.nc or &lt;&gt;.TSDE files (in that order)</span>

<span class="sd">        One can limit the tried files to only one file by passing</span>
<span class="sd">        only a single file ending.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the density matrix</span>
<span class="sd">            By default this is ``[&quot;nc&quot;, &quot;TSDE&quot;]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;TSDE&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">EDM</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_energy_density_matrix_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">EDM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">EDM</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_energy_density_matrix_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read energy density matrix by reading the &lt;&gt;.nc&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_energy_density_matrix_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_energy_density_matrix</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_energy_density_matrix_tsde</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read energy density matrix from the TSDE file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSDE&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_r_energy_density_matrix_tsde</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.DE.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">EDM</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="c1"># to ensure we get the correct orbital count</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">EDM</span> <span class="o">=</span> <span class="n">tsdeSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_energy_density_matrix</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_r_add_overlap</span><span class="p">(</span><span class="s2">&quot;_r_energy_density_matrix_tsde&quot;</span><span class="p">,</span> <span class="n">EDM</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">EDM</span>

<div class="viewcode-block" id="fdfSileSiesta.read_overlap">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_overlap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Overlap</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try and read the overlap matrix by reading the &lt;&gt;.nc, &lt;&gt;.TSHS files, &lt;&gt;.HSX, &lt;&gt;.onlyS (in that order)</span>

<span class="sd">        One can limit the tried files to only one file by passing</span>
<span class="sd">        only a single file ending.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the overlap matrix</span>
<span class="sd">            By default this is ``[&quot;nc&quot;, &quot;TSHS&quot;, &quot;HSX&quot;, &quot;onlyS&quot;]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;TSHS&quot;</span><span class="p">,</span> <span class="s2">&quot;HSX&quot;</span><span class="p">,</span> <span class="s2">&quot;onlyS&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_overlap_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_overlap_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read overlap from the nc file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_overlap_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_overlap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_overlap_tshs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read overlap from the TSHS file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSHS&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_overlap_tshs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.HS.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="n">S</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="c1"># to ensure we get the correct orbital count</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">tshsSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_overlap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">S</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_overlap_hsx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read overlap from the HSX file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.HSX&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_overlap_hsx</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;Save.HS&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="n">S</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="c1"># to ensure we get the correct orbital count</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">hsxSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_overlap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">S</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_overlap_onlys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read overlap from the onlyS file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.onlyS&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_overlap_onlys</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.S.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="n">S</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="c1"># to ensure we get the correct orbital count</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">onlysSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_overlap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">S</span>

<div class="viewcode-block" id="fdfSileSiesta.read_hamiltonian">
<a class="viewcode-back" href="../../../../api/io/generated/sisl.io.siesta.fdfSileSiesta.html#sisl.io.siesta.fdfSileSiesta.read_hamiltonian">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hamiltonian</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try and read the Hamiltonian by reading the &lt;&gt;.nc, &lt;&gt;.TSHS files, &lt;&gt;.HSX (in that order)</span>

<span class="sd">        One can limit the tried files to only one file by passing</span>
<span class="sd">        only a single file ending.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        order: list of str, optional</span>
<span class="sd">            the order of which to try and read the Hamiltonian.</span>
<span class="sd">            By default this is ``[&quot;nc&quot;, &quot;TSHS&quot;, &quot;HSX&quot;]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">_parse_order</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;TSHS&quot;</span><span class="p">,</span> <span class="s2">&quot;HSX&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_r_hamiltonian_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">H</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_r_hamiltonian_nc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read Hamiltonian from the nc file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_hamiltonian_nc</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CDF.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_hamiltonian</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_hamiltonian_tshs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read Hamiltonian from the TSHS file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.TSHS&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_hamiltonian_tshs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;TS.HS.Save&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="n">H</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="c1"># to ensure we get the correct orbital count</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">tshsSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read_hamiltonian</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">H</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_r_hamiltonian_hsx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read Hamiltonian from the HSX file&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.HSX&quot;</span><span class="p">)</span>
        <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_hamiltonian_hsx</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;Save.HS&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)])</span>
        <span class="n">H</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">hsx</span> <span class="o">=</span> <span class="n">hsxSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_hamiltonian_hsx</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;  got version = </span><span class="si">{</span><span class="n">hsx</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;atoms&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;atoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_basis</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;^hsx&quot;</span><span class="p">)</span>
            <span class="c1"># TODO python 3.11 (category= added)</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">list_warns</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">)</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">hsx</span><span class="o">.</span><span class="n">read_hamiltonian</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">list_warns</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span>
                <span class="n">list_warns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">MissingFermiLevelWarning</span>
            <span class="p">):</span>
                <span class="n">Ef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fermi_level</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">Ef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">H</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">Ef</span><span class="p">)</span>
                <span class="c1"># else Ef is None, then a warning should have been raised.</span>
        <span class="k">return</span> <span class="n">H</span>

    <span class="nd">@default_ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Manipulate a FDF file.&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ArgumentParser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the arguments that is available for this Sile&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>

        <span class="c1"># We must by-pass this fdf-file for importing</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sisl.io.siesta</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sis</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sisl.io.tbtrans</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tbt</span>

        <span class="c1"># The fdf parser is more complicated</span>
        <span class="c1"># It is based on different settings based on the</span>

        <span class="n">sp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Determine which part of the fdf-file that should be processed.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Get the label which retains all the sub-modules</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SystemLabel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;siesta&quot;</span><span class="p">)</span>
        <span class="n">f_label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;.ext&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">label_file</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_file</span><span class="p">(</span><span class="n">f_label</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

        <span class="c1"># The default on all sub-parsers are the retrieval and setting</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">default_namespace</span><span class="p">(</span><span class="n">_fdf</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">_fdf_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ep</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s2">&quot;edit&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Change or read and print data from the fdf file&quot;</span>
        <span class="p">)</span>

        <span class="c1"># As the fdf may provide additional stuff, we do not add EVERYTHING from</span>
        <span class="c1"># the Geometry class.</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">FDFAdd</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">_fdf_first</span><span class="p">:</span>
                    <span class="c1"># Append to the end of the file</span>
                    <span class="k">with</span> <span class="n">ns</span><span class="o">.</span><span class="n">_fdf</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"># SISL added keywords</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="s2">&quot;_fdf_first&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">_fdf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="n">ep</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--set&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;VALUE&quot;</span><span class="p">),</span>
            <span class="n">action</span><span class="o">=</span><span class="n">FDFAdd</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Add a key to the FDF file. If it already exists it will be overwritten&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">FDFGet</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Retrieve the value in standard units</span>
                <span class="c1"># Currently, we write out the unit &quot;as-is&quot;</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">_fdf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">with_unit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> is currently not in the FDF file &quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">_fdf</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">_fdf</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">))</span>

        <span class="n">ep</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--get&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-g&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;KEY&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">FDFGet</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print (to stdout) the value of the key in the FDF file.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># If the XV file exists, it has precedence</span>
        <span class="c1"># of the contained geometry (we will issue</span>
        <span class="c1"># a warning in that case)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">label_file</span><span class="p">(</span><span class="s2">&quot;.XV&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
                <span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Edit the contained geometry in the file&quot;</span>
            <span class="p">)</span>
            <span class="n">tmp_p</span><span class="p">,</span> <span class="n">tmp_ns</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">tmp_p</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">tmp_ns</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Allowed pass due to pythonic reading</span>
            <span class="k">pass</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">label_file</span><span class="p">(</span><span class="s2">&quot;.bands&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
                <span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Manipulate bands file from the Siesta simulation&quot;</span>
            <span class="p">)</span>
            <span class="n">tmp_p</span><span class="p">,</span> <span class="n">tmp_ns</span> <span class="o">=</span> <span class="n">sis</span><span class="o">.</span><span class="n">bandsSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
                <span class="n">tmp_p</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">tmp_ns</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">label_file</span><span class="p">(</span><span class="s2">&quot;.PDOS.xml&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
                <span class="s2">&quot;pdos&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Manipulate PDOS.xml file from the Siesta simulation&quot;</span>
            <span class="p">)</span>
            <span class="n">tmp_p</span><span class="p">,</span> <span class="n">tmp_ns</span> <span class="o">=</span> <span class="n">sis</span><span class="o">.</span><span class="n">pdosSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">tmp_p</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">tmp_ns</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">label_file</span><span class="p">(</span><span class="s2">&quot;.EIG&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
                <span class="s2">&quot;eig&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Manipulate EIG file from the Siesta simulation&quot;</span>
            <span class="p">)</span>
            <span class="n">tmp_p</span><span class="p">,</span> <span class="n">tmp_ns</span> <span class="o">=</span> <span class="n">sis</span><span class="o">.</span><span class="n">eigSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">tmp_p</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">tmp_ns</span><span class="p">)</span>

        <span class="c1"># f = label + &quot;.FA&quot;</span>
        <span class="c1"># if isfile(f):</span>
        <span class="c1">#    tmp_p = sp.add_parser(&quot;force&quot;,</span>
        <span class="c1">#                          help=&quot;Manipulate FA file from the Siesta simulation&quot;)</span>
        <span class="c1">#    tmp_p, tmp_ns = sis.faSileSiesta(f).ArgumentParser(tmp_p, *args, **kwargs)</span>
        <span class="c1">#    namespace = merge_instances(namespace, tmp_ns)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">label_file</span><span class="p">(</span><span class="s2">&quot;.TBT.nc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;tbt&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Manipulate tbtrans output file&quot;</span><span class="p">)</span>
            <span class="n">tmp_p</span><span class="p">,</span> <span class="n">tmp_ns</span> <span class="o">=</span> <span class="n">tbt</span><span class="o">.</span><span class="n">tbtncSileTBtrans</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
                <span class="n">tmp_p</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">tmp_ns</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">label_file</span><span class="p">(</span><span class="s2">&quot;.TBT.Proj.nc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
                <span class="s2">&quot;tbt-proj&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Manipulate tbtrans projection output file&quot;</span>
            <span class="p">)</span>
            <span class="n">tmp_p</span><span class="p">,</span> <span class="n">tmp_ns</span> <span class="o">=</span> <span class="n">tbt</span><span class="o">.</span><span class="n">tbtprojncSileTBtrans</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
                <span class="n">tmp_p</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">tmp_ns</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">label_file</span><span class="p">(</span><span class="s2">&quot;.PHT.nc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;pht&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Manipulate the phtrans output file&quot;</span><span class="p">)</span>
            <span class="n">tmp_p</span><span class="p">,</span> <span class="n">tmp_ns</span> <span class="o">=</span> <span class="n">tbt</span><span class="o">.</span><span class="n">phtncSilePHtrans</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
                <span class="n">tmp_p</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">tmp_ns</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">label_file</span><span class="p">(</span><span class="s2">&quot;.PHT.Proj.nc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
                <span class="s2">&quot;pht-proj&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Manipulate phtrans projection output file&quot;</span>
            <span class="p">)</span>
            <span class="n">tmp_p</span><span class="p">,</span> <span class="n">tmp_ns</span> <span class="o">=</span> <span class="n">tbt</span><span class="o">.</span><span class="n">phtprojncSilePHtrans</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
                <span class="n">tmp_p</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">tmp_ns</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">label_file</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">tmp_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Manipulate Siesta NetCDF output file&quot;</span><span class="p">)</span>
            <span class="n">tmp_p</span><span class="p">,</span> <span class="n">tmp_ns</span> <span class="o">=</span> <span class="n">sis</span><span class="o">.</span><span class="n">ncSileSiesta</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">tmp_p</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">tmp_ns</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">namespace</span>


<span class="n">add_sile</span><span class="p">(</span><span class="s2">&quot;fdf&quot;</span><span class="p">,</span> <span class="n">fdfSileSiesta</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015-2025, sisl developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>