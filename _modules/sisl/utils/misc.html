

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sisl.utils.misc &mdash; sisl</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=4c969af8" />
      <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom_styles.css?v=cafe85c1" />
      <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=e6be679b"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=7800a641"></script>
      <script src="../../../_static/tabs.js?v=3ee01567"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            sisl
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cite.html">Citing sisl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualization/index.html">Visualization (<code class="xref py py-obj docutils literal notranslate"><span class="pre">sisl.viz</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">Command line scripts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../environment.html">Environment variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toolbox/index.html">Toolboxes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/index.html">Contributing to sisl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extras</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../math.html">Mathematical notation convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other.html">Related software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../references.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">sisl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sisl.utils.misc</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sisl.utils.misc</h1><div class="highlight"><pre>
<span></span><span class="c1"># This Source Code Form is subject to the terms of the Mozilla Public</span>
<span class="c1"># License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<span class="c1"># file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">pi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numbers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integral</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;merge_instances&quot;</span><span class="p">,</span> <span class="s2">&quot;str_spec&quot;</span><span class="p">,</span> <span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="s2">&quot;listify&quot;</span><span class="p">,</span> <span class="s2">&quot;angle&quot;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;iter_shape&quot;</span><span class="p">,</span> <span class="s2">&quot;math_eval&quot;</span><span class="p">,</span> <span class="s2">&quot;allow_kwargs&quot;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;import_attr&quot;</span><span class="p">,</span> <span class="s2">&quot;lazy_import&quot;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;PropertyDict&quot;</span><span class="p">,</span> <span class="s2">&quot;NotNonePropertyDict&quot;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;size_to_num&quot;</span><span class="p">,</span> <span class="s2">&quot;size_to_elements&quot;</span><span class="p">]</span>


<span class="c1"># supported operators</span>
<span class="n">_operators</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Add</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">add</span><span class="p">,</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Sub</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Mult</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Div</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">truediv</span><span class="p">,</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Pow</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">pow</span><span class="p">,</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">BitXor</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">xor</span><span class="p">,</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">USub</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">neg</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="math_eval">
<a class="viewcode-back" href="../../../api/generated/sisl.utils.math_eval.html#sisl.utils.math_eval">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">math_eval</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate a mathematical expression using a safe evaluation method</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr :</span>
<span class="sd">       the string to be evaluated using math</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; math_eval(&quot;2^6&quot;)</span>
<span class="sd">    4</span>
<span class="sd">    &gt;&gt;&gt; math_eval(&quot;2**6&quot;)</span>
<span class="sd">    64</span>
<span class="sd">    &gt;&gt;&gt; math_eval(&quot;1 + 2*3**(4^5) / (6 + -7)&quot;)</span>
<span class="sd">    -5.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_eval</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_eval</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>  <span class="c1"># &lt;number&gt;</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span>  <span class="c1"># &lt;left&gt; &lt;operator&gt; &lt;right&gt;</span>
        <span class="k">return</span> <span class="n">_operators</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)](</span><span class="n">_eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">),</span> <span class="n">_eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">):</span>  <span class="c1"># &lt;operator&gt; &lt;operand&gt; e.g., -1</span>
        <span class="k">return</span> <span class="n">_operators</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)](</span><span class="n">_eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">merge_instances</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merges an arbitrary number of instances together.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args : obj</span>
<span class="sd">       all objects dictionaries gets appended to a new class</span>
<span class="sd">       which is returned.</span>
<span class="sd">    name : str, optional</span>
<span class="sd">       name of class to merge, default to ``&quot;MergedClass&quot;``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;MergedClass&quot;</span><span class="p">)</span>
    <span class="c1"># We must make a new-type class</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{})</span>
    <span class="c1"># Create holder of class</span>
    <span class="c1"># We could have</span>
    <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>


<span class="k">def</span><span class="w"> </span><span class="nf">size_to_num</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MB&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a size-specification to a size in a specific `unit`</span>

<span class="sd">    Converts the input value (`size`) into a number corresponding to</span>
<span class="sd">    the `size` converted to the specified `unit`.</span>

<span class="sd">    If `size` is passed as an integer (or float), it will be interpreted</span>
<span class="sd">    as a size in MB. Otherwise the string may contain the size specification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">size</span>

    <span class="c1"># Now parse the size from a string</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d+[.\d]*)(\D*)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">unit_in</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Now parse things</span>
    <span class="c1"># We expect data to be in MB (default unit)</span>
    <span class="c1"># Then we can always convert</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span>
        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s2">&quot;kb&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s2">&quot;kB&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s2">&quot;mb&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;MB&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s2">&quot;GB&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s2">&quot;TB&quot;</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">unit_in</span><span class="p">:</span>
        <span class="n">unit_in</span> <span class="o">=</span> <span class="n">conv</span><span class="p">[</span><span class="n">unit_in</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unit_in</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Convert the requested unit</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">conv</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">size</span> <span class="o">*</span> <span class="n">unit_in</span> <span class="o">/</span> <span class="n">unit</span>


<span class="k">def</span><span class="w"> </span><span class="nf">size_to_elements</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">byte_per_elem</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the number of elements such that they occupy `size` memory</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    size :</span>
<span class="sd">        a size specification, either by an integer, or a str. If an integer it is</span>
<span class="sd">        assumed to be in MB, otherwise the str can hold a unit specification.</span>
<span class="sd">    byte_per_elem</span>
<span class="sd">        number of bytes per element when doing the conversion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">size_to_num</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">//</span> <span class="n">byte_per_elem</span><span class="p">)</span>


<div class="viewcode-block" id="iter_shape">
<a class="viewcode-back" href="../../../api/generated/sisl.utils.iter_shape.html#sisl.utils.iter_shape">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">iter_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generator for iterating a shape by returning consecutive slices</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape : array_like</span>
<span class="sd">      the shape of the iterator</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    tuple of int</span>
<span class="sd">       a tuple of the same length as the input shape. The iterator</span>
<span class="sd">       is using the C-indexing.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; for slc in iter_shape([2, 1, 3]):</span>
<span class="sd">    ...    print(slc)</span>
<span class="sd">    [0, 0, 0]</span>
<span class="sd">    [0, 0, 1]</span>
<span class="sd">    [0, 0, 2]</span>
<span class="sd">    [1, 0, 0]</span>
<span class="sd">    [1, 0, 1]</span>
<span class="sd">    [1, 0, 2]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">]</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">ns1</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1"># Create list for iterating</span>
    <span class="c1"># we require a list because tuple&#39;s are immutable</span>
    <span class="n">slc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ns</span>

    <span class="k">while</span> <span class="n">slc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">ns1</span><span class="p">]):</span>
            <span class="n">slc</span><span class="p">[</span><span class="n">ns1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">yield</span> <span class="n">slc</span>

        <span class="c1"># Increment the previous shape indices</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">slc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">shape1</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">slc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">slc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="str_spec">
<a class="viewcode-back" href="../../../api/generated/sisl.utils.str_spec.html#sisl.utils.str_spec">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">str_spec</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split into a tuple of name and specifier, delimited by ``{...}``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">       string to split</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple of str</span>
<span class="sd">       returns the name and the specifier (without delimiter) in a tuple</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; str_spec(&quot;hello&quot;)</span>
<span class="sd">    (&quot;hello&quot;, None)</span>
<span class="sd">    &gt;&gt;&gt; str_spec(&quot;hello{TEST}&quot;)</span>
<span class="sd">    (&quot;hello&quot;, &quot;TEST&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">lname</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;{&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lname</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>



<span class="n">IterableAny</span> <span class="o">=</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
<span class="n">IterableInstantiation</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">IterableAny</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Listify</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert arguments to an iterable-like (any iterable, default to `list`)</span>

<span class="sd">    It provides also an easy mechanism for &quot;piping&quot; content to</span>
<span class="sd">    a function call (for better readability).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cls:</span>
<span class="sd">        the default list-like object to cast it to</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; listify = Listify()</span>
<span class="sd">    &gt;&gt;&gt; 1 | listify</span>
<span class="sd">    [1]</span>
<span class="sd">    &gt;&gt;&gt; Listify(tuple)(1)</span>
<span class="sd">    (1,)</span>

<span class="sd">    It can greatly improve readability with `map` constructs:</span>
<span class="sd">    &gt;&gt;&gt; map(lambda x, [1]) | listify</span>
<span class="sd">    [1]</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If using this to convert to `tuple` instances ``Listify(tuple)``,</span>
<span class="sd">    please do note the problems of using a tuple as indices for</span>
<span class="sd">    `numpy.ndarray` objects.</span>

<span class="sd">    This is partly inspired by `pip &lt;https://pypi.org/project/pipe/&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_cls&quot;</span><span class="p">,)</span>

    <span class="c1"># Ensures that numpy function calls won&#39;t happen!</span>
    <span class="c1"># Just a higher priority than *any* numpy arrays and subclasses.</span>
    <span class="n">__array_priority__</span> <span class="o">=</span> <span class="mi">1000000</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">IterableInstantiation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span> <span class="o">=</span> <span class="bp">cls</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IterableInstantiation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IterableAny</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">arg</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">([</span><span class="n">arg</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IterableAny</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allow piping of function calls (on the right side)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>


<span class="n">listify</span> <span class="o">=</span> <span class="n">Listify</span><span class="p">()</span>


<span class="c1"># Transform a string to a Cartesian direction</span>
<div class="viewcode-block" id="direction">
<a class="viewcode-back" href="../../../api/generated/sisl.utils.direction.html#sisl.utils.direction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">direction</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">abc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Index coordinate transformation from int/str to an integer</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d : {0, &quot;x&quot;, &quot;a&quot;, 1, &quot;y&quot;, &quot;b&quot;, 2, &quot;z&quot;, &quot;c&quot;}</span>
<span class="sd">       returns the integer that corresponds to the coordinate index (strings are</span>
<span class="sd">       lower-cased).</span>
<span class="sd">    abc : (3, 3), optional</span>
<span class="sd">       for ``&quot;abc&quot;`` inputs the returned value will be the vector ``abc[direction(d)]``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    index : int</span>
<span class="sd">       index of the Cartesian coordinate system, only if both `abc` and `xyz` are none</span>
<span class="sd">       or if the requested direction is not present, only returned if the corresponding direction</span>
<span class="sd">       is none</span>
<span class="sd">    vector : (3,)</span>
<span class="sd">       the vector corresponding to the value gotten from `abc` or `xyz`, only returned</span>
<span class="sd">       if the corresponding direction is not none</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; direction(0)</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; direction(&quot;Y&quot;)</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; direction(&quot;z&quot;)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; direction(&quot;2&quot;)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; direction(&quot; 2&quot;)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; direction(&quot;b&quot;)</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; direction(&quot;b&quot;, abc=np.diag([1, 2, 3])</span>
<span class="sd">    [0, 2, 0]</span>
<span class="sd">    &gt;&gt;&gt; direction(&quot;x&quot;, abc=np.diag([1, 2, 3])</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; direction(1, abc=np.diag([1, 2, 3])</span>
<span class="sd">    [0, 2, 0]</span>
<span class="sd">    &gt;&gt;&gt; direction(1, abc=np.diag([1, 2, 3], xyz=np.diag([4, 5, 6])</span>
<span class="sd">    [0, 2, 0]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Integral</span><span class="p">):</span>
        <span class="c1"># pass through to find it</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="c1"># We take it as a string</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">abc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">in</span> <span class="s2">&quot;abc012&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">abc</span><span class="p">[</span><span class="s2">&quot;a0b1c2&quot;</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">in</span> <span class="s2">&quot;xyz012&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xyz</span><span class="p">[</span><span class="s2">&quot;x0y1z2&quot;</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;xa0yb1zc2&quot;</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;direction: Input direction is not an integer, nor a string in &#39;xyz/abc/012&#39;&quot;</span>
    <span class="p">)</span></div>



<span class="c1"># Transform an input to an angle</span>
<div class="viewcode-block" id="angle">
<a class="viewcode-back" href="../../../api/generated/sisl.utils.angle.html#sisl.utils.angle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">angle</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">in_rad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert the input string to an angle, either radians or degrees.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s :</span>
<span class="sd">       If `s` starts with &#39;r&#39; it is interpreted as radians ``[0:2pi]``.</span>
<span class="sd">       If `s` starts with &#39;a&#39; it is interpreted as a regular angle ``[0:360]``.</span>
<span class="sd">       If `s` ends with &#39;r&#39; it returns in radians.</span>
<span class="sd">       If `s` ends with &#39;a&#39; it returns in regular angle.</span>

<span class="sd">       `s` may be any mathematical equation which can be</span>
<span class="sd">       intercepted through ``eval``.</span>
<span class="sd">    rad :</span>
<span class="sd">       Whether the returned angle is in radians.</span>
<span class="sd">       Note than an &#39;r&#39; at the end of `s` has precedence.</span>
<span class="sd">    in_rad :</span>
<span class="sd">       Whether the calculated angle is in radians.</span>
<span class="sd">       Note than an &#39;r&#39; at the beginning of `s` has precedence.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">       the angle in the requested unit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">):</span>
        <span class="n">in_rad</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">):</span>
        <span class="n">in_rad</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">):</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">):</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Remove all r/a&#39;s and remove white-space</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Figure out if Pi is circumfered by */+-</span>
    <span class="n">spi</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;pi&quot;</span><span class="p">)</span>
    <span class="n">nspi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nspi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># We have pi at least in one place.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">si</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spi</span><span class="p">):</span>
            <span class="c1"># In case the last element is a pi</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nspi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">si</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)):</span>
                    <span class="c1"># it *MUST* be &quot;*&quot;</span>
                    <span class="n">spi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">si</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)):</span>
                    <span class="c1"># it *MUST* be &quot;*&quot;</span>
                    <span class="n">spi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">spi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Now insert Pi dependent on the input type</span>
        <span class="k">if</span> <span class="n">in_rad</span><span class="p">:</span>
            <span class="n">Pi</span> <span class="o">=</span> <span class="n">pi</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pi</span> <span class="o">=</span> <span class="mf">180.0</span>

        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Pi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spi</span><span class="p">)</span>

    <span class="c1"># We have now transformed all values</span>
    <span class="c1"># to the correct numerical values and we calculate</span>
    <span class="c1"># the expression</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">math_eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rad</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_rad</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ra</span> <span class="o">/</span> <span class="mf">180.0</span> <span class="o">*</span> <span class="n">pi</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rad</span> <span class="ow">and</span> <span class="n">in_rad</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ra</span> <span class="o">/</span> <span class="n">pi</span> <span class="o">*</span> <span class="mf">180.0</span>

    <span class="c1"># Both radians and in_radians are equivalent</span>
    <span class="c1"># so return as-is</span>
    <span class="k">return</span> <span class="n">ra</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">allow_kwargs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decoractor for forcing `func` to have the named arguments as listed in `args`</span>

<span class="sd">    This decorator merely removes any keyword argument from the called function</span>
<span class="sd">    which is in the list of `args` in case the function does not have the arguments</span>
<span class="sd">    or a ``**kwargs`` equivalent.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args : str</span>
<span class="sd">       required arguments in `func`, if already present nothing will be done.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">deco</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Build list of arguments and keyword arguments</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">arg_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kwargs_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span><span class="p">):</span>
                <span class="n">arg_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">:</span>
                <span class="n">kwargs_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="c1"># First we figure out which arguments are already in the lists</span>
        <span class="n">args_</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">]</span>

        <span class="c1"># Now we have the compressed lists</span>
        <span class="c1"># If there are no arguments required to be added, simply return the function</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="c1"># Basically any function that does not have a named argument</span>
        <span class="c1"># cannot use it. So we simply need to create a function which by-passes</span>
        <span class="c1"># the named arguments.</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">dec_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Simply remove all the arguments that cannot be passed to the function</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args_</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dec_func</span>

    <span class="k">return</span> <span class="n">deco</span>


<span class="k">def</span><span class="w"> </span><span class="nf">import_attr</span><span class="p">(</span><span class="n">attr_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns an attribute from a full module path</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; func = import_attr(&quot;sisl.utils.import_attr&quot;)</span>
<span class="sd">    &gt;&gt;&gt; assert func is import_attr</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    attr_path: str</span>
<span class="sd">        the module path to the attribute</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">module</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">attr_path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">lazy_import</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lazily import a module or submodule</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">       module name to load, optionally a sub-package from `package`</span>
<span class="sd">    package : str, optional</span>
<span class="sd">       whether `name` is a sub-package</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; hello = lazy_import(&quot;hello&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hello.mod_func</span>

<span class="sd">    This will only load the module upon method inspection in</span>
<span class="sd">    the module.</span>

<span class="sd">    &gt;&gt;&gt; hello = lazy_import(&quot;.hello&quot;, &quot;package&quot;)</span>
<span class="sd">    &gt;&gt;&gt; hello.mod_func</span>

<span class="sd">    The dot is required to indicate it being a name within package.</span>

<span class="sd">    NOTE currently this is not working due to id&#39;s changing upon</span>
<span class="sd">    actual loading. I have yet to figure out why...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">util</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span>

    <span class="n">abs_name</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">resolve_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">abs_name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">abs_name</span><span class="p">]</span>

    <span class="c1"># Create module specification</span>
    <span class="c1"># Find specifications for module</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">abs_name</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="c1"># Make module with proper locking and get it inserted into sys.modules.</span>
    <span class="n">util</span><span class="o">.</span><span class="n">LazyLoader</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="p">)</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">module</span>


<span class="c1"># This class is very much like the addict type</span>
<span class="c1"># However, a much reduced usage</span>


<div class="viewcode-block" id="PropertyDict">
<a class="viewcode-back" href="../../../api/generated/sisl.utils.PropertyDict.html#sisl.utils.PropertyDict">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PropertyDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple dictionary which may access items as properties as well&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="fm">__setattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__setitem__</span>
    <span class="fm">__delattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__delitem__</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">NotNonePropertyDict</span><span class="p">(</span><span class="n">PropertyDict</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015-2025, sisl developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>